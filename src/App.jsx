import { useState, useEffect } from "react";
import { createClient } from "@supabase/supabase-js";

/* ═══ Supabase Client ═══ */
const supabase = createClient(
  "https://aoucmzltqqjertteajdt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvdWNtemx0cXFqZXJ0dGVhamR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDQ2NzksImV4cCI6MjA4NjI4MDY3OX0.Qp8mn6udn7Tm-VNnxrR505emktEgeZmvRaWj9rJ-aIQ"
);

const LOGO_B64 = "data:image/png;base64,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";

/* ═══ Destination Codes (defaults, user can customize) ═══ */
const DEFAULT_DEST_CODES = {
  SYX: { name: "Хайнан", bank: "Хаан банк", color: "#0891B2", bg: "#ECFEFF" },
  PQC: { name: "Фукок", bank: "Худалдаа хөгжлийн банк", color: "#7C3AED", bg: "#F5F3FF" },
  JAP: { name: "Япон", bank: "М Банк", color: "#DC2626", bg: "#FEF2F2" },
};
const DEST_COLORS = ["#0891B2","#7C3AED","#DC2626","#059669","#D97706","#4F46E5","#BE185D","#0369A1","#65A30D","#C026D3","#EA580C","#0D9488"];
const DEST_BGS = ["#ECFEFF","#F5F3FF","#FEF2F2","#ECFDF5","#FFFBEB","#EEF2FF","#FDF2F8","#F0F9FF","#F7FEE7","#FDF4FF","#FFF7ED","#F0FDFA"];
const ALL_BANKS = {
  "Хаан банк": { bank: "Хаан банк", iban: "MN31 000 500 5076302485" },
  "Худалдаа хөгжлийн банк": { bank: "Худалдаа хөгжлийн банк", iban: "MN06 0004 000 453105281" },
  "М Банк": { bank: "М Банк", iban: "MN43 0039 00 0013366699" },
};
const COMPANY = "НЬЮ ЖУУЛЧИН ТУРС ХХК";
const REGISTER = "2738341";
const COMPANY_ADDR = "Хан-Уул дүүрэг, 20-р хороо\nМишээл Лайф Стайл М2 Цамхаг\n10 давхар, 1006 тоот";
const fmt = (n) => "₮" + Number(n||0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
const pct = (a, b) => b ? Math.round((a / b) * 100) : 0;

/* ═══ Theme ═══ */
const C = {
  wine: "#5B2830", winePale: "#F9F0F1", wineBg: "#FDF5F6",
  dark: "#1C1012", text: "#2D1518", muted: "#8C6B6F", light: "#B89A9D",
  border: "#E8D5D7", cream: "#FEFBF9", gold: "#C8A96E", goldLight: "#F7F0E0",
  green: "#065F46", greenBg: "#ECFDF5", greenBd: "#A7F3D0",
  orange: "#9A3412", orangeBg: "#FFF7ED", orangeBd: "#FED7AA",
  red: "#991B1B", redBg: "#FEF2F2", redBd: "#FECACA",
  blue: "#1E40AF", blueBg: "#EFF6FF", blueBd: "#BFDBFE",
};

/* ═══ Helpers ═══ */
const genTripCode = (destCode, date, seq = 1) => {
  const d = new Date(date);
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  const ss = String(seq).padStart(2, "0");
  return `${destCode}-${yy}${mm}${dd}${ss}`;
};
const parseTripCode = (code) => {
  const m = code.match(/^([A-Z]+)-(\d{2})(\d{2})(\d{2})(\d{2})$/);
  if (!m) return null;
  return { dest: m[1], year: "20" + m[2], month: m[3], day: m[4], seq: m[5], date: `20${m[2]}-${m[3]}-${m[4]}` };
};
const statusInfo = { paid: { color: C.green, bg: C.greenBg, bd: C.greenBd, label: "Төлсөн", icon: "✓" }, partial: { color: C.orange, bg: C.orangeBg, bd: C.orangeBd, label: "Хэсэгчлэн", icon: "◐" }, pending: { color: C.red, bg: C.redBg, bd: C.redBd, label: "Хүлээгдэж буй", icon: "○" }, cancelled: { color: "#6B7280", bg: "#F3F4F6", bd: "#D1D5DB", label: "Цуцлагдсан", icon: "✕" } };
const badge = (s) => { const m = statusInfo[s] || statusInfo.pending; return { display:"inline-flex", alignItems:"center", gap:4, fontSize:10, fontWeight:700, padding:"3px 10px", borderRadius:20, background:m.bg, color:m.color, border:`1px solid ${m.bd}` }; };


export default function ManagerPlatform() {
  // ── Auth ──
  const DEFAULT_USERS = [
    { username: "admin", password: "admin1234", role: "admin", label: "Админ" },
    { username: "manager", password: "1234", role: "manager", label: "Менежер" },
    { username: "booking", password: "5678", role: "booking", label: "Booking Manager" },
    { username: "finance", password: "1111", role: "finance", label: "Санхүүгийн менежер" },
  ];
  const [users, setUsers] = useState(DEFAULT_USERS);
  const [currentUser, setCurrentUser] = useState(null);
  const [loginUser, setLoginUser] = useState("");
  const [loginPass, setLoginPass] = useState("");
  const [loginError, setLoginError] = useState("");
  const isAdmin = currentUser?.role === "admin";
  const isManager = isAdmin || currentUser?.role === "manager";
  const isBooking = currentUser?.role === "booking";
  const isFinance = currentUser?.role === "finance";

  // Admin form
  const [adminNewUser, setAdminNewUser] = useState("");
  const [adminNewPass, setAdminNewPass] = useState("");
  const [adminNewRole, setAdminNewRole] = useState("booking");
  const [adminNewLabel, setAdminNewLabel] = useState("");

  // Load users from storage
  const loadUsers = async () => {
    try {
      const { data } = await supabase.from("app_users").select("data").eq("id", "default").single();
      if (data?.data) {
        const stored = data.data;
        let merged = [...stored];
        for (const du of DEFAULT_USERS) {
          if (!merged.find(u => u.username === du.username)) merged.push(du);
        }
        if (merged.length !== stored.length) {
          await supabase.from("app_users").upsert({ id: "default", data: merged });
        }
        setUsers(merged);
      }
    } catch(e) { /* use defaults */ }
  };
  const saveUsers = async (u) => {
    setUsers(u);
    try { await supabase.from("app_users").upsert({ id: "default", data: u }); } catch(e) {}
  };

  // Login disabled via URL params for security

  const handleLogin = () => {
    const u = users.find(u => u.username === loginUser && u.password === loginPass);
    if (u) { setCurrentUser(u); setLoginError(""); setLoginUser(""); setLoginPass(""); if(u.role==="finance") setPage("finance"); else setPage("trips"); }
    else { setLoginError("Хэрэглэгч нэр эсвэл нууц үг буруу"); }
  };

  const [page, setPage] = useState("trips"); // "trips" | "dest-trips" | "trip-detail" | "new-invoice" | "analytics" | "settings" | "pdf-preview" | "recycle"
  const [trips, setTrips] = useState([]);
  const [invoices, setInvoices] = useState([]);
  const [loading, setLoading] = useState(true);
  const [saveMsg, setSaveMsg] = useState("");
  const [selectedTrip, setSelectedTrip] = useState(null);
  const [selectedInvoice, setSelectedInvoice] = useState(null);
  const [selectedDest, setSelectedDest] = useState(null);
  const [filterDest, setFilterDest] = useState("all");
  const [searchQ, setSearchQ] = useState("");
  const [dashboardMonths, setDashboardMonths] = useState(3);
  const [finFrom, setFinFrom] = useState(() => { const d = new Date(); d.setMonth(d.getMonth()-3); return d.toISOString().split("T")[0]; });
  const [finTo, setFinTo] = useState(new Date().toISOString().split("T")[0]);
  const [finDest, setFinDest] = useState("all");
  const [finResult, setFinResult] = useState(null);

  // Edit invoice
  const [editingInvoice, setEditingInvoice] = useState(null);
  const [invSearchQ, setInvSearchQ] = useState("");
  const [finDestFilter, setFinDestFilter] = useState(null);
  const [finTripFilter, setFinTripFilter] = useState(null);
  const [expandedInv, setExpandedInv] = useState(null);
  const [analyticsYear, setAnalyticsYear] = useState(new Date().getFullYear());
  const [analyticsView, setAnalyticsView] = useState("monthly"); // "monthly" | "destination" | "yearly"
  const [analyticsMonth, setAnalyticsMonth] = useState(null);
  const [destCodes, setDestCodes] = useState(DEFAULT_DEST_CODES);
  const [tripsGroupByMonth, setTripsGroupByMonth] = useState(true);
  const [collapsedMonths, setCollapsedMonths] = useState({});

  // Settings form
  const [editCode, setEditCode] = useState("");
  const [editName, setEditName] = useState("");
  const [editBank, setEditBank] = useState("Хаан банк");
  const [editColor, setEditColor] = useState(0);

  // Cancel trip modal
  const [showCancelModal, setShowCancelModal] = useState(false);
  const [cancelReason, setCancelReason] = useState("");

  // Alias for backward compat
  const DEST_CODES = destCodes;

  // New trip form
  const [newDest, setNewDest] = useState("SYX");
  const [newDate, setNewDate] = useState(new Date().toISOString().split("T")[0]);
  const [newSeq, setNewSeq] = useState(1);
  const [showNewTrip, setShowNewTrip] = useState(false);
  const [customDest, setCustomDest] = useState("");
  const [customDestName, setCustomDestName] = useState("");

  // Invoice form
  const [invClient, setInvClient] = useState("");
  const [invPhone, setInvPhone] = useState("");
  const [invType, setInvType] = useState("package"); // "flight" | "ground" | "package"
  const [invItems, setInvItems] = useState([{ id: 1, description: "", qty: 1, rate: 0 }]);
  const [invNotes, setInvNotes] = useState("");
  const [invDueDate, setInvDueDate] = useState("");
  const [invInfant, setInvInfant] = useState(false);
  const [invInstall, setInvInstall] = useState(false);
  const [invInstallCount, setInvInstallCount] = useState(2);
  const [invInstallments, setInvInstallments] = useState([]);
  // Each installment: { pct: number, date: string }

  // ── Storage (Supabase) ──
  const loadAll = async () => {
    setLoading(true);
    try {
      // Load dest codes
      try {
        const { data } = await supabase.from("dest_codes").select("data").eq("id", "default").single();
        if (data?.data) setDestCodes(data.data);
      } catch(e) {}
      // Load trips
      const { data: tripRows } = await supabase.from("trips").select("*").order("date", { ascending: false });
      const tAll = (tripRows || []).map(r => ({ ...r.data, code: r.code, dest: r.dest, destName: r.dest_name, date: r.date, seq: r.seq, bank: r.bank, status: r.status, cancelReason: r.cancel_reason, cancelledAt: r.cancelled_at, createdAt: r.created_at, createdBy: r.created_by, createdByLabel: r.created_by_label }));
      setTrips(tAll);
      // Load invoices
      const { data: invRows } = await supabase.from("invoices").select("*").order("created_at", { ascending: false });
      const iAll = (invRows || []).map(r => ({ ...r.data, id: r.id, tripCode: r.trip_code }));
      // Migrate: fix refCodes and txnValues
      const tripInvCounts = {};
      const sorted = [...iAll].sort((a, b) => (a.savedAt || "").localeCompare(b.savedAt || ""));
      for (const inv of sorted) {
        if (inv.tripCode) {
          if (!tripInvCounts[inv.tripCode]) tripInvCounts[inv.tripCode] = 0;
          tripInvCounts[inv.tripCode]++;
          const baseCode = inv.tripCode.replace(/-/g, "").toLowerCase();
          const correctRef = `${baseCode}-${String(tripInvCounts[inv.tripCode]).padStart(2, "0")}`;
          const correctTxn = [correctRef, inv.clientName, inv.clientPhone].filter(Boolean).join(" / ");
          if (inv.refCode !== correctRef || inv.txnValue !== correctTxn) {
            inv.refCode = correctRef;
            inv.txnValue = correctTxn;
            try { await supabase.from("invoices").update({ data: inv }).eq("id", inv.id); } catch(e) {}
          }
        }
      }
      setInvoices(iAll);
    } catch(e) { console.error("loadAll error:", e); }
    setLoading(false);
  };

  const saveDestCodes = async (newCodes) => {
    setDestCodes(newCodes);
    try { await supabase.from("dest_codes").upsert({ id: "default", data: newCodes }); } catch(e) {}
  };

  const addDestCode = async () => {
    const code = editCode.toUpperCase().trim();
    if (!code || code.length < 2 || code.length > 5) { setSaveMsg("⚠ Код 2-5 үсэг байх ёстой"); setTimeout(()=>setSaveMsg(""),3000); return; }
    if (!editName.trim()) { setSaveMsg("⚠ Нэр оруулна уу"); setTimeout(()=>setSaveMsg(""),3000); return; }
    const ci = editColor % DEST_COLORS.length;
    const updated = { ...destCodes, [code]: { name: editName.trim(), bank: editBank, color: DEST_COLORS[ci], bg: DEST_BGS[ci] } };
    await saveDestCodes(updated);
    setEditCode(""); setEditName(""); setEditBank("Хаан банк");
    setSaveMsg("✓ Чиглэл нэмэгдлээ!"); setTimeout(()=>setSaveMsg(""),3000);
  };

  const removeDestCode = async (code) => {
    const updated = { ...destCodes };
    delete updated[code];
    await saveDestCodes(updated);
    setSaveMsg("✓ Устгагдлаа"); setTimeout(()=>setSaveMsg(""),3000);
  };

  const cancelTrip = async (trip, reason) => {
    if (!reason.trim()) { setSaveMsg("⚠ Цуцлах шалтгаан бичнэ үү"); setTimeout(()=>setSaveMsg(""),3000); return false; }
    // Check if any invoice has been paid
    const invs = invoices.filter(i => i.tripCode === trip.code);
    const hasPaid = invs.some(i => i.paymentStatus === "paid" || (i.installments?.some(x => x.paid)));
    if (hasPaid) { setSaveMsg("⚠ Төлсөн нэхэмжлэлтэй аялал цуцлах боломжгүй!"); setTimeout(()=>setSaveMsg(""),4000); return false; }
    // Update trip status
    const updated = { ...trip, status: "cancelled", cancelReason: reason, cancelledAt: new Date().toISOString() };
    await saveTrip(updated);
    setTrips(prev => prev.map(t => t.code === trip.code ? updated : t));
    setSelectedTrip(updated);
    // Cancel all pending invoices
    for (const inv of invs) {
      if (inv.paymentStatus !== "paid") {
        const updInv = { ...inv, paymentStatus: "cancelled" };
        await saveInv(updInv);
        setInvoices(prev => prev.map(i => i.id === inv.id ? updInv : i));
      }
    }
    setShowCancelModal(false);
    setCancelReason("");
    setSaveMsg("✓ Аялал цуцлагдлаа"); setTimeout(()=>setSaveMsg(""),3000);
    return true;
  };

  const deleteTrip = async (trip) => {
    const invs = invoices.filter(i => i.tripCode === trip.code);
    const hasPaid = invs.some(i => i.paymentStatus === "paid" || (i.payments?.length > 0) || (i.installments?.some(x => x.paid)));
    if (hasPaid) { setSaveMsg("⚠ Төлбөр төлөгдсөн нэхэмжлэлтэй аялал устгах боломжгүй!"); setTimeout(()=>setSaveMsg(""),4000); return; }
    const msg = invs.length > 0
      ? `"${trip.code}" аялал болон ${invs.length} нэхэмжлэл хогийн савруу зөөгдөнө. Устгах уу?`
      : `"${trip.code}" аялал хогийн савруу зөөх үү?`;
    if (!window.confirm(msg)) return;
    try {
      const now = new Date().toISOString();
      // Soft delete all invoices
      for (const inv of invs) {
        const upd = { ...inv, deleted: true, deletedAt: now, deletedBy: currentUser.username };
        await saveInv(upd);
        setInvoices(prev => prev.map(i => i.id === inv.id ? upd : i));
      }
      // Soft delete trip
      const updTrip = { ...trip, deleted: true, deletedAt: now, deletedBy: currentUser.username };
      await saveTrip(updTrip);
      setTrips(prev => prev.map(t => t.code === trip.code ? updTrip : t));
      setSelectedTrip(null);
      setPage("trips");
      setSaveMsg("✓ Хогийн саванд зөөгдлөө"); setTimeout(()=>setSaveMsg(""),3000);
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); setTimeout(()=>setSaveMsg(""),5000); }
  };

  const restoreTrip = async (trip) => {
    try {
      const invs = invoices.filter(i => i.tripCode === trip.code && i.deleted);
      for (const inv of invs) {
        const upd = { ...inv, deleted: false, deletedAt: null, deletedBy: null };
        await saveInv(upd);
        setInvoices(prev => prev.map(i => i.id === inv.id ? upd : i));
      }
      const updTrip = { ...trip, deleted: false, deletedAt: null, deletedBy: null };
      await saveTrip(updTrip);
      setTrips(prev => prev.map(t => t.code === trip.code ? updTrip : t));
      setSaveMsg("✓ Аялал сэргээгдлээ!"); setTimeout(()=>setSaveMsg(""),3000);
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); setTimeout(()=>setSaveMsg(""),5000); }
  };

  const permanentDeleteTrip = async (trip) => {
    if (!window.confirm(`"${trip.code}" бүрмөсөн устгах уу? Дахин сэргээх боломжгүй!`)) return;
    try {
      const invs = invoices.filter(i => i.tripCode === trip.code);
      for (const inv of invs) { await supabase.from("invoices").delete().eq("id", inv.id); }
      await supabase.from("trips").delete().eq("code", trip.code);
      setInvoices(prev => prev.filter(i => i.tripCode !== trip.code));
      setTrips(prev => prev.filter(t => t.code !== trip.code));
      setSaveMsg("✓ Бүрмөсөн устгагдлаа"); setTimeout(()=>setSaveMsg(""),3000);
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); setTimeout(()=>setSaveMsg(""),5000); }
  };

  const saveTrip = async (trip) => {
    try {
      await supabase.from("trips").upsert({
        code: trip.code, dest: trip.dest, dest_name: trip.destName, date: trip.date,
        seq: trip.seq, bank: trip.bank, status: trip.status || "active",
        cancel_reason: trip.cancelReason, cancelled_at: trip.cancelledAt,
        created_at: trip.createdAt, created_by: trip.createdBy,
        created_by_label: trip.createdByLabel, data: trip
      });
    } catch(e) {}
  };

  const saveInv = async (inv) => {
    try {
      await supabase.from("invoices").upsert({
        id: inv.id, trip_code: inv.tripCode, data: inv, created_at: inv.savedAt || new Date().toISOString()
      });
    } catch(e) {}
  };

  const createTrip = async () => {
    try {
    const destCode = customDest || newDest;
    if (!destCode || destCode.length < 2) { setSaveMsg("⚠ Чиглэлийн код оруулна уу"); setTimeout(()=>setSaveMsg(""),3000); return; }
    // If custom code not in destCodes, add it
    let destInfo = destCodes[destCode];
    if (!destInfo && customDest) {
      const ci = Object.keys(destCodes).length % DEST_COLORS.length;
      destInfo = { name: customDestName || destCode, bank: "Хаан банк", color: DEST_COLORS[ci], bg: DEST_BGS[ci] };
      await saveDestCodes({ ...destCodes, [destCode]: destInfo });
    }
    if (!destInfo) destInfo = { name: destCode, bank: "Хаан банк", color: C.wine, bg: C.winePale };
    const code = genTripCode(destCode, newDate, newSeq);
    if (trips.find(t => t.code === code)) { setSaveMsg("⚠ Энэ кодтой аялал бүртгэгдсэн байна"); setTimeout(()=>setSaveMsg(""),3000); return; }
    const trip = { code, dest: destCode, destName: destInfo.name, date: newDate, seq: newSeq, bank: destInfo.bank, createdAt: new Date().toISOString(), createdBy: currentUser.username, createdByLabel: currentUser.label };
    await saveTrip(trip);
    setTrips(prev => [trip, ...prev].sort((a,b)=>(b.date||"").localeCompare(a.date||"")));
    setShowNewTrip(false);
    setCustomDest(""); setCustomDestName("");
    setSaveMsg("✓ Аялал бүртгэгдлээ!"); setTimeout(()=>setSaveMsg(""),3000);
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); setTimeout(()=>setSaveMsg(""),5000); }
  };

  const submitInvoice = async () => {
    // Validate all required fields
    if (!invClient.trim()) { setSaveMsg("⚠ Зорчигчийн нэр оруулна уу"); setTimeout(()=>setSaveMsg(""),3000); return; }
    if (!invPhone.trim()) { setSaveMsg("⚠ Утасны дугаар оруулна уу"); setTimeout(()=>setSaveMsg(""),3000); return; }
    // Validate items - each must have description, qty > 0, rate > 0
    const emptyItem = invItems.find(i => !i.description?.trim() || !i.qty || i.qty <= 0 || !i.rate || i.rate <= 0);
    if (emptyItem) { setSaveMsg("⚠ Үйлчилгээ, тоо, үнэ бүрэн бөглөнө үү"); setTimeout(()=>setSaveMsg(""),3000); return; }
    const trip = selectedTrip;
    const bankInfo = ALL_BANKS[trip.bank] || Object.values(ALL_BANKS)[0];
    const total = invItems.reduce((s, i) => s + i.qty * i.rate, 0);
    const txnValue = [trip.code, invClient, invPhone].filter(Boolean).join(" / ");
    let instArr = [];
    if (invInstall) {
      instArr = Array.from({ length: invInstallCount }, (_, i) => {
        const pctVal = invInstallments[i]?.pct ?? Math.round(100 / invInstallCount);
        const amt = Math.round(total * pctVal / 100);
        return {
          label: `${i+1}-р төлбөр`, amount: amt, pct: pctVal,
          date: invInstallments[i]?.date || "", paid: false,
        };
      });
      // Adjust last installment to account for rounding
      const sumSoFar = instArr.slice(0, -1).reduce((s, x) => s + x.amount, 0);
      instArr[instArr.length - 1].amount = total - sumSoFar;
    }
    // Generate unique reference code: jap26022101-01
    const baseCode = trip.code.replace(/-/g, "").toLowerCase();
    const existingInvs = invoices.filter(i => i.tripCode === trip.code);
    const invSeq = String(existingInvs.length + 1).padStart(2, "0");
    const refCode = `${baseCode}-${invSeq}`;

    const inv = {
      id: refCode, refCode, tripCode: trip.code, dest: trip.dest, destName: trip.destName,
      invDate: new Date().toISOString().split("T")[0], dueDate: invDueDate,
      clientName: invClient, clientPhone: invPhone, isInfant: invInfant, invType,
      bankName: bankInfo.bank, bankIban: bankInfo.iban,
      items: invItems.map(i => ({ description: i.description || `${trip.destName} аялал`, qty: i.qty, rate: i.rate, type: i.type || "package" })),
      total, notes: invNotes, installEnabled: invInstall,
      installments: instArr, txnValue: [refCode, invClient, invPhone].filter(Boolean).join(" / "), savedAt: new Date().toISOString(), paymentStatus: "pending",
      createdBy: currentUser.username, createdByLabel: currentUser.label,
    };
    await saveInv(inv);
    setInvoices(prev => [inv, ...prev]);
    // Reset form
    setInvClient(""); setInvPhone(""); setInvInfant(false); setInvType("package"); setInvItems([{ id: 1, description: "", qty: 1, rate: 0 }]);
    setInvNotes(""); setInvDueDate(""); setInvInstall(false); setInvInstallments([]);
    setPage("trip-detail");
    setSaveMsg("✓ Нэхэмжлэл бүртгэгдлээ!"); setTimeout(()=>setSaveMsg(""),3000);
  };

  useEffect(() => { loadAll(); loadUsers(); }, []);

  // ── Seed test data ──

  // ── Computed ──
  const activeTrips = trips.filter(t => !t.deleted);
  const activeInvoices = invoices.filter(i => !i.deleted);
  const deletedTrips = trips.filter(t => t.deleted);
  const deletedInvoices = invoices.filter(i => i.deleted && !deletedTrips.some(dt => dt.code === i.tripCode));
  const tripInvoices = (code) => activeInvoices.filter(i => i.tripCode === code);
  const tripStats = (code) => {
    const invs = tripInvoices(code);
    const total = invs.reduce((s, i) => s + (i.total || 0), 0);
    const paid = invs.filter(i => i.paymentStatus === "paid").reduce((s, i) => s + (i.total || 0), 0);
    const partial = invs.filter(i => i.paymentStatus === "partial");
    const partialPaid = partial.reduce((s, i) => {
      if (!i.installments?.length) return s;
      return s + i.installments.filter(x => x.paid).reduce((ss, x) => ss + x.amount, 0);
    }, 0);
    // Count from line items: type per item, qty = number of people
    let flightPeople = 0, groundPeople = 0, packagePeople = 0, infantPeople = 0;
    invs.forEach(inv => {
      (inv.items || []).forEach(it => {
        const t = it.type || inv.invType || "package";
        const q = it.qty || 1;
        if (t === "infant") infantPeople += q;
        else if (t === "flight") flightPeople += q;
        else if (t === "ground") groundPeople += q;
        else packagePeople += q; // package
      });
    });
    // Seats = flight + package (infant and ground don't count)
    const seatCount = flightPeople + packagePeople;
    const infantCount = infantPeople;
    return { count: invs.length, seatCount, infantCount, flightCount: flightPeople, groundCount: groundPeople, packageCount: packagePeople, total, paid: paid + partialPaid, outstanding: total - paid - partialPaid, allPaid: invs.length > 0 && invs.every(i => i.paymentStatus === "paid"), paidCount: invs.filter(i=>i.paymentStatus==="paid").length, pendingCount: invs.filter(i=>i.paymentStatus==="pending").length, partialCount: partial.length };
  };

  const filteredTrips = trips.filter(t => {
    if (filterDest !== "all" && t.dest !== filterDest) return false;
    if (searchQ) {
      const q = searchQ.toLowerCase();
      // Search trip-level fields
      if (t.code.toLowerCase().includes(q)) return true;
      if ((t.destName||"").toLowerCase().includes(q)) return true;
      if ((t.dest||"").toLowerCase().includes(q)) return true;
      if ((t.bank||"").toLowerCase().includes(q)) return true;
      // Search inside invoices for this trip
      const invs = invoices.filter(i => i.tripCode === t.code);
      return invs.some(inv =>
        (inv.clientName||"").toLowerCase().includes(q) ||
        (inv.clientPhone||"").includes(q) ||
        (inv.bankName||"").toLowerCase().includes(q) ||
        (inv.bankIban||"").toLowerCase().includes(q) ||
        (inv.destName||"").toLowerCase().includes(q) ||
        (inv.txnValue||"").toLowerCase().includes(q)
      );
    }
    return true;
  });

  // ── Analytics computations ──
  const MONTHS = ["1-р сар","2-р сар","3-р сар","4-р сар","5-р сар","6-р сар","7-р сар","8-р сар","9-р сар","10-р сар","11-р сар","12-р сар"];
  const availableYears = [...new Set(activeTrips.map(t => new Date(t.date).getFullYear()))].sort((a,b)=>b-a);
  useEffect(() => {
    if (!availableYears.includes(analyticsYear) && availableYears.length) setAnalyticsYear(availableYears[0]);
  }, [availableYears.join(",")]);

  const yearTrips = activeTrips.filter(t => new Date(t.date).getFullYear() === analyticsYear);
  const yearInvoices = activeInvoices.filter(inv => {
    const trip = activeTrips.find(t => t.code === inv.tripCode);
    return trip && new Date(trip.date).getFullYear() === analyticsYear;
  });

  // ── Due date notifications ──
  const today = new Date(); today.setHours(0,0,0,0);
  const getDueStatus = (dateStr) => {
    if (!dateStr) return null;
    const due = new Date(dateStr); due.setHours(0,0,0,0);
    const diff = Math.ceil((due - today) / (1000*60*60*24));
    if (diff < 0) return { type: "overdue", days: Math.abs(diff), label: `${Math.abs(diff)} хоног хэтэрсэн`, color: C.red, bg: C.redBg, bd: C.redBd };
    if (diff === 0) return { type: "today", days: 0, label: "Өнөөдөр!", color: C.red, bg: C.redBg, bd: C.redBd };
    if (diff <= 3) return { type: "soon", days: diff, label: `${diff} хоногийн дотор`, color: C.orange, bg: C.orangeBg, bd: C.orangeBd };
    return null;
  };

  // Gather all upcoming/overdue installments
  const notifications = [];
  invoices.forEach(inv => {
    if (inv.paymentStatus === "paid" || inv.paymentStatus === "cancelled") return;
    if (inv.installEnabled && inv.installments?.length) {
      inv.installments.forEach((inst, idx) => {
        if (inst.paid) return;
        const ds = getDueStatus(inst.date);
        if (ds) notifications.push({ ...ds, inv, instIdx: idx, instLabel: inst.label, amount: inst.amount });
      });
    } else {
      const ds = getDueStatus(inv.dueDate);
      if (ds) notifications.push({ ...ds, inv, instIdx: null, instLabel: null, amount: inv.total });
    }
  });
  notifications.sort((a,b) => (a.days - b.days));

  const getPaidAmount = (inv) => {
    if (inv.payments?.length) return inv.payments.filter(p=>!p.reversed).reduce((s,p)=>s+p.amount,0);
    if (inv.paymentStatus === "paid") return inv.total || 0;
    if (inv.installEnabled && inv.installments?.length) return inv.installments.filter(x=>x.paid).reduce((s,x)=>s+x.amount,0);
    return 0;
  };

  // Monthly breakdown
  const monthlyData = Array.from({length:12}, (_,m) => {
    const mTrips = yearTrips.filter(t => new Date(t.date).getMonth() === m);
    const mInvs = yearInvoices.filter(inv => { const trip = trips.find(t=>t.code===inv.tripCode); return trip && new Date(trip.date).getMonth()===m; });
    const totalAmt = mInvs.reduce((s,i) => s + (i.total||0), 0);
    const paidAmt = mInvs.reduce((s,i) => s + getPaidAmount(i), 0);
    return { month: m, label: MONTHS[m], trips: mTrips.length, invoices: mInvs.length, total: totalAmt, paid: paidAmt, outstanding: totalAmt - paidAmt };
  });

  // ── Financial query ──
  const runFinQuery = () => {
    const from = new Date(finFrom); from.setHours(0,0,0,0);
    const to = new Date(finTo); to.setHours(23,59,59,999);
    const fTrips = trips.filter(t => {
      const d = new Date(t.date);
      if (d < from || d > to) return false;
      if (finDest !== "all" && t.dest !== finDest) return false;
      return true;
    });
    const fInvs = invoices.filter(inv => {
      const trip = fTrips.find(t => t.code === inv.tripCode);
      return !!trip;
    });
    const total = fInvs.reduce((s,i) => s + (i.total||0), 0);
    const paid = fInvs.reduce((s,i) => s + getPaidAmount(i), 0);
    setFinResult({ trips: fTrips.length, invoices: fInvs.length, total, paid, outstanding: total - paid, invs: fInvs });
  };

  // ── Excel export ──
  const exportCSV = () => {
    if (!finResult) return;
    const rows = [["Нэр","Утас","Аялал","Чиглэл","Огноо","Нийт","Төлсөн","Үлдэгдэл","Төлөв"]];
    finResult.invs.forEach(inv => {
      const trip = trips.find(t=>t.code===inv.tripCode);
      const paid = getPaidAmount(inv);
      rows.push([inv.clientName, inv.clientPhone, inv.tripCode, inv.destName||inv.dest, trip?.date||"", inv.total, paid, inv.total-paid, inv.paymentStatus]);
    });
    const csv = rows.map(r => r.map(c => `"${c}"`).join(",")).join("\n");
    const BOM = "\uFEFF";
    const blob = new Blob([BOM + csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = `NJT_report_${finFrom}_${finTo}.csv`; a.click(); URL.revokeObjectURL(url);
  };

  // ── Edit invoice ──
  const startEditInvoice = (inv) => {
    setEditingInvoice(inv);
    setInvClient(inv.clientName || "");
    setInvPhone(inv.clientPhone || "");
    setInvInfant(inv.isInfant || false);
    setInvType(inv.invType || "package");
    setInvItems(inv.items || [{ id:1, description:"", qty:1, rate:0 }]);
    setInvNotes(inv.notes || "");
    setInvDueDate(inv.dueDate || "");
    setInvInstall(inv.installEnabled || false);
    setInvInstallCount(inv.installments?.length || 2);
    setInvInstallments(inv.installments?.map(i => ({ pct: i.pct || 0, date: i.date || "" })) || []);
    setPage("new-invoice");
  };

  const saveEditInvoice = async () => {
    if (!invClient.trim()) { setSaveMsg("⚠ Зорчигчийн нэр оруулна уу"); setTimeout(()=>setSaveMsg(""),3000); return; }
    if (!invPhone.trim()) { setSaveMsg("⚠ Утасны дугаар оруулна уу"); setTimeout(()=>setSaveMsg(""),3000); return; }
    const emptyItem = invItems.find(i => !i.description?.trim() || !i.qty || i.qty <= 0 || !i.rate || i.rate <= 0);
    if (emptyItem) { setSaveMsg("⚠ Үйлчилгээ, тоо, үнэ бүрэн бөглөнө үү"); setTimeout(()=>setSaveMsg(""),3000); return; }
    const inv = editingInvoice;
    const total = invItems.reduce((s,i) => s + i.qty * i.rate, 0);
    const trip = trips.find(t => t.code === inv.tripCode);
    // Generate refCode if missing
    let refCode = inv.refCode;
    if (!refCode && trip) {
      const baseCode = trip.code.replace(/-/g, "").toLowerCase();
      const existingInvs = invoices.filter(i => i.tripCode === trip.code);
      const idx = existingInvs.findIndex(i => i.id === inv.id);
      const invSeq = String((idx >= 0 ? idx : existingInvs.length) + 1).padStart(2, "0");
      refCode = `${baseCode}-${invSeq}`;
    }
    const txnValue = [refCode, invClient, invPhone].filter(Boolean).join(" / ");
    let instArr = inv.installments || [];
    if (invInstall) {
      instArr = Array.from({ length: invInstallCount }, (_, i) => {
        const pctVal = invInstallments[i]?.pct ?? Math.round(100 / invInstallCount);
        const amt = Math.round(total * pctVal / 100);
        const oldInst = inv.installments?.[i];
        return { label: `${i+1}-р төлбөр`, amount: amt, pct: pctVal, date: invInstallments[i]?.date || "", paid: oldInst?.paid || false };
      });
      const sumSoFar = instArr.slice(0,-1).reduce((s,x) => s + x.amount, 0);
      instArr[instArr.length-1].amount = total - sumSoFar;
    }
    // Build edit history entry
    const editEntry = {
      date: new Date().toISOString(),
      by: currentUser.username, byLabel: currentUser.label,
      changes: [],
    };
    if (inv.clientName !== invClient) editEntry.changes.push(`Нэр: ${inv.clientName} → ${invClient}`);
    if (inv.clientPhone !== invPhone) editEntry.changes.push(`Утас: ${inv.clientPhone} → ${invPhone}`);
    if (inv.total !== total) editEntry.changes.push(`Дүн: ${fmt(inv.total)} → ${fmt(total)}`);
    if (inv.notes !== invNotes) editEntry.changes.push(`Тэмдэглэл өөрчлөгдсөн`);
    const editHistory = [...(inv.editHistory || []), ...(editEntry.changes.length > 0 ? [editEntry] : [])];

    const updated = {
      ...inv,
      refCode, clientName: invClient, clientPhone: invPhone, isInfant: invInfant, invType,
      items: invItems, total, notes: invNotes, dueDate: invDueDate,
      txnValue, installEnabled: invInstall, installments: instArr,
      editHistory,
    };
    // If booking manager, put edit in pending approval
    if (isBooking && editEntry.changes.length > 0) {
      updated.pendingEdit = {
        by: currentUser.username,
        date: new Date().toISOString(),
        changes: editEntry.changes,
        data: { clientName: invClient, clientPhone: invPhone, isInfant: invInfant, invType, items: invItems, total, notes: invNotes, dueDate: invDueDate, txnValue, installEnabled: invInstall, installments: instArr },
      };
      try {
        await saveInv(updated);
        setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
        setSaveMsg("✓ Засвар илгээгдлээ! Менежер батлах хүлээгдэж байна.");
        setEditingInvoice(null);
        setPage("trip-detail");
      } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
      setTimeout(()=>setSaveMsg(""),3000);
      return;
    }
    // Recalc payment status
    if (invInstall && instArr.length > 0) {
      const allPaid = instArr.every(x => x.paid);
      const somePaid = instArr.some(x => x.paid);
      updated.paymentStatus = allPaid ? "paid" : somePaid ? "partial" : "pending";
    }
    try {
      await saveInv(updated);
      setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
      setSaveMsg("✓ Нэхэмжлэл засагдлаа!");
      setEditingInvoice(null);
      setPage("trip-detail");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  // ── Approve/Reject pending edit ──
  const approvePendingEdit = async (inv) => {
    const pe = inv.pendingEdit;
    if (!pe) return;
    const updated = { ...inv, ...pe.data, pendingEdit: null };
    const editHistory = [...(inv.editHistory || []), { date: new Date().toISOString(), changes: [...pe.changes, "✓ Менежер батлав"] }];
    updated.editHistory = editHistory;
    if (updated.installEnabled && updated.installments?.length > 0) {
      const allPaid = updated.installments.every(x => x.paid);
      const somePaid = updated.installments.some(x => x.paid);
      updated.paymentStatus = allPaid ? "paid" : somePaid ? "partial" : "pending";
    }
    try {
      await saveInv(updated);
      setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
      setSaveMsg("✓ Засвар батлагдлаа!");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  const rejectPendingEdit = async (inv) => {
    const updated = { ...inv, pendingEdit: null };
    const editHistory = [...(inv.editHistory || []), { date: new Date().toISOString(), changes: ["✕ Засвар цуцлагдсан (Менежер)"] }];
    updated.editHistory = editHistory;
    try {
      await saveInv(updated);
      setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
      setSaveMsg("✕ Засвар цуцлагдлаа");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  // ── Toggle installment paid (Finance & Manager only) ──
  const toggleInstallmentPaid = async (inv, instIdx) => {
    if (!isFinance && !isAdmin) { setSaveMsg("⚠ Зөвхөн санхүүгийн менежер төлбөр бүртгэх эрхтэй"); setTimeout(()=>setSaveMsg(""),3000); return; }
    const updated = { ...inv };
    const inst = [...(updated.installments || [])];
    inst[instIdx] = { ...inst[instIdx], paid: !inst[instIdx].paid, paidDate: !inst[instIdx].paid ? new Date().toISOString() : null };
    updated.installments = inst;
    const allPaid = inst.every(x => x.paid);
    const somePaid = inst.some(x => x.paid);
    updated.paymentStatus = allPaid ? "paid" : somePaid ? "partial" : "pending";
    const editHistory = [...(updated.editHistory || []), { date: new Date().toISOString(), changes: [`${inst[instIdx].label}: ${inst[instIdx].paid ? "Төлсөн ✓" : "Төлөөгүй болгов"} (${currentUser?.label})`] }];
    updated.editHistory = editHistory;
    try {
      await saveInv(updated);
      setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
      setSaveMsg(inst[instIdx].paid ? "✓ Төлбөр бүртгэгдлээ" : "Төлбөр цуцлагдлаа");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  // ── Toggle full payment (Finance & Manager only) ──
  const toggleFullPayment = async (inv) => {
    if (!isFinance && !isAdmin) { setSaveMsg("⚠ Зөвхөн санхүүгийн менежер төлбөр бүртгэх эрхтэй"); setTimeout(()=>setSaveMsg(""),3000); return; }
    const updated = { ...inv };
    const newStatus = inv.paymentStatus === "paid" ? "pending" : "paid";
    updated.paymentStatus = newStatus;
    const editHistory = [...(updated.editHistory || []), { date: new Date().toISOString(), changes: [newStatus === "paid" ? "Бүрэн төлсөн ✓" : "Төлөөгүй болгов", `(${currentUser?.label})`] }];
    updated.editHistory = editHistory;
    try {
      await saveInv(updated);
      setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
      setSaveMsg(newStatus === "paid" ? "✓ Бүрэн төлбөр бүртгэгдлээ" : "Төлбөр цуцлагдлаа");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  // ── Delete invoice (Manager only) ──
  const deleteInvoice = async (inv) => {
    if (!window.confirm(`"${inv.clientName}" нэхэмжлэл хогийн савруу зөөх үү?`)) return;
    try {
      const upd = { ...inv, deleted: true, deletedAt: new Date().toISOString(), deletedBy: currentUser.username };
      await saveInv(upd);
      setInvoices(prev => prev.map(i => i.id === inv.id ? upd : i));
      setSaveMsg("✓ Хогийн саванд зөөгдлөө");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  const restoreInvoice = async (inv) => {
    try {
      const upd = { ...inv, deleted: false, deletedAt: null, deletedBy: null };
      await saveInv(upd);
      setInvoices(prev => prev.map(i => i.id === inv.id ? upd : i));
      setSaveMsg("✓ Нэхэмжлэл сэргээгдлээ!");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  const permanentDeleteInvoice = async (inv) => {
    if (!window.confirm(`"${inv.clientName}" бүрмөсөн устгах уу?`)) return;
    try {
      await supabase.from("invoices").delete().eq("id", inv.id);
      setInvoices(prev => prev.filter(i => i.id !== inv.id));
      setSaveMsg("✓ Бүрмөсөн устгагдлаа");
    } catch(e) { setSaveMsg("⚠ Алдаа: " + e.message); }
    setTimeout(()=>setSaveMsg(""),3000);
  };

  const destData = Object.entries(
    yearTrips.reduce((acc, t) => {
      const key = t.dest;
      if (!acc[key]) acc[key] = { dest: key, name: t.destName || key, trips: [], invoices: [] };
      acc[key].trips.push(t);
      return acc;
    }, {})
  ).map(([_, d]) => {
    const dInvs = yearInvoices.filter(inv => inv.dest === d.dest);
    d.invoices = dInvs;
    d.invoiceCount = dInvs.length;
    d.total = dInvs.reduce((s,i) => s + (i.total||0), 0);
    d.paid = dInvs.reduce((s,i) => s + getPaidAmount(i), 0);
    d.outstanding = d.total - d.paid;
    d.tripCount = d.trips.length;
    return d;
  }).sort((a,b) => b.total - a.total);

  // Yearly summary (all years)
  const yearlyData = availableYears.map(yr => {
    const yTrips = trips.filter(t => new Date(t.date).getFullYear() === yr);
    const yInvs = invoices.filter(inv => { const trip = trips.find(t=>t.code===inv.tripCode); return trip && new Date(trip.date).getFullYear()===yr; });
    const totalAmt = yInvs.reduce((s,i) => s + (i.total||0), 0);
    const paidAmt = yInvs.reduce((s,i) => s + getPaidAmount(i), 0);
    return { year: yr, trips: yTrips.length, invoices: yInvs.length, total: totalAmt, paid: paidAmt, outstanding: totalAmt - paidAmt };
  });

  // Month detail trips (when clicking a month)
  const monthDetailTrips = analyticsMonth !== null ? yearTrips.filter(t => new Date(t.date).getMonth() === analyticsMonth) : [];

  // Year totals
  const yearTotal = yearInvoices.reduce((s,i)=>s+(i.total||0),0);
  const yearPaid = yearInvoices.reduce((s,i)=>s+getPaidAmount(i),0);
  const yearOutstanding = yearTotal - yearPaid;
  const maxMonthly = Math.max(...monthlyData.map(m=>m.total), 1);

  // ── Styles ──
  const inp = { width:"100%", padding:"10px 14px", border:`1px solid ${C.border}`, borderRadius:10, fontSize:13, fontFamily:"'Outfit',sans-serif", background:"#fff", outline:"none", boxSizing:"border-box", color:C.text, transition:"all .15s" };
  const lbl = { display:"block", fontSize:9, fontWeight:700, letterSpacing:".14em", textTransform:"uppercase", color:C.light, marginBottom:5, fontFamily:"'Outfit'" };
  const btnP = { padding:"8px 20px", background:C.wine, color:"#fff", border:"none", borderRadius:8, cursor:"pointer", fontFamily:"'Outfit'", fontWeight:600, fontSize:12 };
  const btnS = { ...btnP, background:"transparent", color:C.muted, border:`1px solid ${C.border}` };
  const cardS = { background:C.cream, borderRadius:14, border:`1px solid ${C.border}`, padding:"20px 24px", marginBottom:10 };


  /* ═══════════════════════════════════════════
     PDF PREVIEW (print-ready invoice)
     ═══════════════════════════════════════════ */
  if (page === "pdf-preview" && selectedInvoice) {
    const inv = selectedInvoice;
    const bankInfo = ALL_BANKS[inv.bankName] || { bank: inv.bankName, iban: inv.bankIban };
    const trip = trips.find(t => t.code === inv.tripCode);
    const destInfo = DEST_CODES[inv.dest] || { color: C.wine, name: inv.destName || inv.dest };
    const itemCount = (inv.items||[]).length;
    const hasInstall = inv.installEnabled && inv.installments?.length > 0;
    // Compact mode for ≤6 items to fit one A4 page
    const compact = itemCount <= 6;
    const S = compact ? 0.88 : 1; // scale factor for compact
    return (
      <>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
          *{box-sizing:border-box;margin:0;padding:0}
          @media print {
            body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact}
            .no-print{display:none!important}
            @page{margin:0;size:A4}
          }
        `}</style>
        <div style={{fontFamily:"'Outfit',sans-serif",maxWidth:780,margin:"0 auto",padding:"0 0 40px",color:C.text}}>

          {/* Floating nav */}
          <div className="no-print" style={{position:"fixed",top:20,left:"50%",transform:"translateX(-50%)",display:"flex",gap:8,zIndex:99,background:"rgba(255,255,255,0.95)",backdropFilter:"blur(12px)",padding:"6px 12px",borderRadius:50,boxShadow:"0 4px 24px rgba(91,40,48,0.12)",border:`1px solid ${C.border}`}}>
            <button onClick={()=>setPage("trip-detail")} style={{padding:"7px 18px",background:"transparent",color:C.muted,border:`1px solid ${C.border}`,borderRadius:50,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:500,fontSize:12}}>← Буцах</button>
            <button onClick={()=>window.print()} style={{padding:"7px 20px",background:C.wine,color:"#fff",border:"none",borderRadius:50,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:600,fontSize:12}}>🖨 Хэвлэх / PDF</button>
          </div>

          {/* Header banner */}
          <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:`${compact?18:28}px 40px`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
            <img src={LOGO_B64} alt="Logo" style={{height:compact?36:48,objectFit:"contain"}} />
            <div style={{textAlign:"right",color:C.muted,fontSize:compact?10:11,lineHeight:1.8}}>
              <div style={{color:C.wine,fontWeight:600,fontSize:compact?11:13}}>{COMPANY}</div>
              <div>Регистр: {REGISTER}</div>
            </div>
          </div>

          <div style={{padding:`${compact?20:36}px 40px 0`}}>
            {/* Title row */}
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-end",marginBottom:compact?16:32,paddingBottom:compact?12:20,borderBottom:`2px solid ${C.wine}`}}>
              <div>
                <div style={{fontSize:compact?8:9,fontWeight:700,letterSpacing:"0.22em",textTransform:"uppercase",color:C.wine,marginBottom:4}}>Нэхэмжлэл</div>
                <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:compact?26:34,fontWeight:700,color:C.dark,lineHeight:1}}>{inv.tripCode}</div>
              </div>
              <div style={{textAlign:"right",fontSize:compact?11:12.5,color:C.muted,lineHeight:1.8}}>
                <div><b style={{color:C.text}}>Чиглэл:</b> {inv.destName || inv.dest}</div>
                <div><b style={{color:C.text}}>Огноо:</b> {inv.invDate}</div>
                {inv.dueDate && <div><b style={{color:C.text}}>Хугацаа:</b> {inv.dueDate}</div>}
                {trip?.date && <div><b style={{color:C.text}}>Нисэх:</b> {trip.date}</div>}
              </div>
            </div>

            {/* From / To */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:compact?24:40,marginBottom:compact?14:28}}>
              <div>
                <div style={{fontSize:8,fontWeight:700,letterSpacing:"0.2em",textTransform:"uppercase",color:C.light,marginBottom:compact?4:8}}>Илгээгч</div>
                <div style={{fontSize:compact?12:14,fontWeight:700,color:C.dark,marginBottom:2}}>{COMPANY}</div>
                <div style={{fontSize:compact?10.5:12,color:C.muted,whiteSpace:"pre-wrap",lineHeight:1.6}}>{COMPANY_ADDR}</div>
              </div>
              <div>
                <div style={{fontSize:8,fontWeight:700,letterSpacing:"0.2em",textTransform:"uppercase",color:C.light,marginBottom:compact?4:8}}>Хүлээн авагч</div>
                <div style={{fontSize:compact?12:14,fontWeight:700,color:C.dark,marginBottom:2}}>{inv.clientName||"—"}</div>
                {inv.clientPhone && <div style={{fontSize:compact?10.5:12,color:C.muted}}>Утас: {inv.clientPhone}</div>}
              </div>
            </div>

            {/* Bank info */}
            <div style={{background:C.winePale,border:`1px solid ${C.border}`,borderRadius:compact?8:10,padding:`${compact?12:18}px ${compact?16:24}px`,marginBottom:compact?6:10}}>
              <div style={{fontSize:8,fontWeight:700,letterSpacing:"0.2em",textTransform:"uppercase",color:C.wine,marginBottom:compact?6:12}}>Банкны мэдээлэл</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:compact?10:16}}>
                {[["Банк",inv.bankName,false],["Данс",inv.bankIban,true],["Хүлээн авагч",COMPANY,false],["Регистр",REGISTER,true]].map(([l,v,m])=>(
                  <div key={l}><div style={{fontSize:compact?8.5:9.5,color:C.muted,marginBottom:1}}>{l}</div><div style={{fontSize:compact?11:13,fontWeight:700,color:C.dark,fontFamily:m?"'Outfit',monospace":"inherit",letterSpacing:m?"0.05em":0}}>{v}</div></div>
                ))}
              </div>
            </div>

            {/* Disclaimer + Transaction value - combined in compact mode */}
            <div style={{display:"grid",gridTemplateColumns:compact?"1fr 1fr":"1fr",gap:compact?6:0,marginBottom:compact?14:0}}>
              <div style={{background:"#FFF8F0",border:"1px solid #F5D5B8",borderRadius:compact?8:10,padding:`${compact?8:14}px ${compact?12:24}px`,marginBottom:compact?0:10,fontSize:compact?10:11.5,color:"#8B4513",lineHeight:1.7}}>
                <b>⚠ АЯЛЛЫН ДУГААР</b>, <b>НЭР</b>, <b>УТАС</b>-аа гүйлгээний утга дээр заавал бичээрэй!
              </div>
              <div style={{background:C.goldLight,border:`1px solid ${C.gold}33`,borderRadius:compact?8:10,padding:`${compact?8:14}px ${compact?12:24}px`,marginBottom:compact?0:32,display:"flex",alignItems:"center",gap:10}}>
                <span style={{fontSize:compact?7.5:8.5,fontWeight:700,letterSpacing:"0.14em",textTransform:"uppercase",color:C.gold,whiteSpace:"nowrap",background:"#fff",padding:"2px 8px",borderRadius:6,border:`1px solid ${C.gold}44`}}>Гүйлгээний утга</span>
                <span style={{fontSize:compact?12:14,fontWeight:700,color:C.dark,fontFamily:"'Outfit',monospace"}}>{inv.txnValue || inv.refCode}</span>
              </div>
            </div>

            {/* Items table */}
            <table style={{width:"100%",borderCollapse:"collapse",marginBottom:compact?14:28}}>
              <thead><tr>
                {["Тайлбар","Тоо","Нэгж үнэ","Дүн"].map((h,i)=>(
                  <th key={h} style={{textAlign:i?"right":"left",padding:`${compact?7:11}px ${compact?6:10}px ${compact?7:11}px 0`,fontSize:compact?7.5:8.5,fontWeight:700,letterSpacing:"0.18em",textTransform:"uppercase",color:C.light,borderBottom:`2px solid ${C.border}`}}>{h}</th>
                ))}
              </tr></thead>
              <tbody>{(inv.items||[]).map((it,idx)=>(
                <tr key={idx} style={{borderBottom:`1px solid ${C.border}22`}}>
                  <td style={{padding:`${compact?8:13}px ${compact?6:10}px ${compact?8:13}px 0`,fontSize:compact?11.5:13,fontWeight:500}}>{it.description||`Үйлчилгээ ${idx+1}`}</td>
                  <td style={{padding:`${compact?8:13}px 0`,fontSize:compact?11.5:13,textAlign:"right",color:C.muted}}>{it.qty}</td>
                  <td style={{padding:`${compact?8:13}px 0`,fontSize:compact?11.5:13,textAlign:"right",color:C.muted}}>{fmt(it.rate)}</td>
                  <td style={{padding:`${compact?8:13}px 0`,fontSize:compact?11.5:13,textAlign:"right",fontWeight:700}}>{fmt(it.qty*it.rate)}</td>
                </tr>
              ))}</tbody>
            </table>

            {/* Total */}
            <div style={{display:"flex",justifyContent:"flex-end",marginBottom:hasInstall?compact?10:20:compact?16:36}}>
              <div style={{background:C.dark,color:"#fff",borderRadius:compact?8:12,padding:`${compact?12:18}px ${compact?24:36}px`,minWidth:compact?200:260,display:"flex",justifyContent:"space-between",alignItems:"baseline",border:`2px solid ${C.wine}`}}>
                <span style={{fontSize:compact?8:10,fontWeight:600,letterSpacing:"0.16em",textTransform:"uppercase",opacity:0.65}}>Нийт дүн</span>
                <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:compact?22:28,fontWeight:700,color:C.gold}}>{fmt(inv.total)}</span>
              </div>
            </div>

            {/* Installment Schedule with percentage */}
            {hasInstall && (
              <div style={{marginBottom:compact?16:36}}>
                <div style={{fontSize:compact?7.5:8.5,fontWeight:700,letterSpacing:"0.2em",textTransform:"uppercase",color:C.wine,marginBottom:compact?6:12}}>Хуваарьт төлбөр</div>
                <table style={{width:"100%",borderCollapse:"collapse"}}>
                  <thead><tr>
                    {["","Төлбөр","Хувь","Дүн","Огноо","Төлөв"].map((h,i)=>(
                      <th key={h||"n"} style={{textAlign:i>2?"right":i===0?"center":"left",padding:`${compact?6:10}px ${compact?6:10}px`,fontSize:compact?7:8.5,fontWeight:700,letterSpacing:"0.16em",textTransform:"uppercase",color:C.light,borderBottom:`2px solid ${C.border}`,width:i===0?28:i===2?50:i===5?compact?70:80:"auto"}}>{h}</th>
                    ))}
                  </tr></thead>
                  <tbody>
                    {inv.installments.map((inst,idx)=>{
                      const pctVal = inv.total > 0 ? Math.round((inst.amount / inv.total) * 100) : 0;
                      return (
                        <tr key={idx} style={{borderBottom:`1px solid ${C.border}33`}}>
                          <td style={{padding:`${compact?6:12}px ${compact?4:10}px`,textAlign:"center",fontSize:compact?10:12,color:C.light,fontWeight:600}}>{idx+1}</td>
                          <td style={{padding:`${compact?6:12}px ${compact?4:10}px`,fontSize:compact?11:13,fontWeight:600,color:C.text}}>{inst.label}</td>
                          <td style={{padding:`${compact?6:12}px ${compact?4:10}px`,fontSize:compact?11:13,fontWeight:700,color:C.wine}}>{pctVal}%</td>
                          <td style={{padding:`${compact?6:12}px ${compact?4:10}px`,fontSize:compact?11:13,fontWeight:700,textAlign:"right",color:C.dark}}>{fmt(inst.amount)}</td>
                          <td style={{padding:`${compact?6:12}px ${compact?4:10}px`,fontSize:compact?10:12,textAlign:"right",color:C.muted}}>{inst.date||"—"}</td>
                          <td style={{padding:`${compact?6:12}px ${compact?4:10}px`,textAlign:"right"}}>
                            <span style={{fontSize:compact?8.5:10,fontWeight:600,padding:`2px ${compact?6:10}px`,borderRadius:20,background:inst.paid?C.greenBg:C.orangeBg,color:inst.paid?C.green:C.orange,border:`1px solid ${inst.paid?C.greenBd:C.orangeBd}`}}>
                              {inst.paid?"Төлсөн":"Хүлээгдэж буй"}
                            </span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                <div style={{display:"flex",justifyContent:"flex-end",marginTop:compact?6:10,gap:compact?12:20,fontSize:compact?10:12}}>
                  <span style={{color:C.muted}}>Төлсөн: <b style={{color:C.green}}>{fmt(inv.installments.filter(i=>i.paid).reduce((s,i)=>s+i.amount,0))}</b></span>
                  <span style={{color:C.muted}}>Үлдэгдэл: <b style={{color:C.wine}}>{fmt(inv.installments.filter(i=>!i.paid).reduce((s,i)=>s+i.amount,0))}</b></span>
                </div>
              </div>
            )}

            {/* Notes */}
            {inv.notes && (
              <div style={{padding:`${compact?8:16}px ${compact?12:22}px`,background:C.cream,borderRadius:compact?8:10,border:`1px solid ${C.border}`,fontSize:compact?10:12,color:C.muted,lineHeight:1.7,marginBottom:compact?10:20}}>
                <div style={{fontSize:compact?7.5:8.5,fontWeight:700,letterSpacing:"0.16em",textTransform:"uppercase",color:C.light,marginBottom:4}}>Тэмдэглэл</div>
                <div style={{whiteSpace:"pre-wrap",color:C.text}}>{inv.notes}</div>
              </div>
            )}

            {/* Footer */}
            <div style={{marginTop:compact?20:44,borderTop:`1px solid ${C.border}`,paddingTop:compact?8:14,textAlign:"center",fontSize:compact?8.5:9.5,color:C.light,letterSpacing:"0.06em"}}>
              {COMPANY} · info@juulchinworld.mn · +976-31 9401 · Мөрөөдлийг дурсамж болгоно
            </div>
          </div>
        </div>
      </>
    );
  }


  /* ═══════════════════════════════════════════
     ADMIN (User Management) - Manager only
     ═══════════════════════════════════════════ */
  if (page === "admin" && isAdmin) return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}
        @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
        .fu{animation:fadeUp .35s ease both}
      `}</style>
      <div style={{minHeight:"100vh",background:C.cream,fontFamily:"'Outfit',sans-serif"}}>
        <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <button onClick={()=>setPage("trips")} style={{background:"none",border:"none",fontSize:14,color:C.muted,cursor:"pointer",fontFamily:"'Outfit'"}}>← Хянах самбар</button>
          </div>
          <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark}}>👥 Хэрэглэгч удирдлага</h2>
          <div/>
        </div>
        <div style={{maxWidth:700,margin:"0 auto",padding:"28px 20px"}}>
          {/* Add user form */}
          <div className="fu" style={{background:"#fff",borderRadius:16,border:`1px solid ${C.border}`,padding:"24px 28px",marginBottom:20}}>
            <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:700,color:C.dark,marginBottom:16}}>Шинэ хэрэглэгч нэмэх</h3>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr auto",gap:10,alignItems:"end"}}>
              <div>
                <label style={{display:"block",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:4}}>Нэвтрэх нэр</label>
                <input value={adminNewUser} onChange={e=>setAdminNewUser(e.target.value)} placeholder="username" style={{width:"100%",padding:"8px 12px",border:`1px solid ${C.border}`,borderRadius:8,fontSize:13,fontFamily:"'Outfit'",outline:"none",boxSizing:"border-box"}}/>
              </div>
              <div>
                <label style={{display:"block",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:4}}>Нууц үг</label>
                <input value={adminNewPass} onChange={e=>setAdminNewPass(e.target.value)} placeholder="password" style={{width:"100%",padding:"8px 12px",border:`1px solid ${C.border}`,borderRadius:8,fontSize:13,fontFamily:"'Outfit'",outline:"none",boxSizing:"border-box"}}/>
              </div>
              <div>
                <label style={{display:"block",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:4}}>Нэр</label>
                <input value={adminNewLabel} onChange={e=>setAdminNewLabel(e.target.value)} placeholder="Батболд" style={{width:"100%",padding:"8px 12px",border:`1px solid ${C.border}`,borderRadius:8,fontSize:13,fontFamily:"'Outfit'",outline:"none",boxSizing:"border-box"}}/>
              </div>
              <div>
                <label style={{display:"block",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:4}}>Эрх</label>
                <select value={adminNewRole} onChange={e=>setAdminNewRole(e.target.value)} style={{width:"100%",padding:"8px 12px",border:`1px solid ${C.border}`,borderRadius:8,fontSize:13,fontFamily:"'Outfit'",outline:"none",boxSizing:"border-box",background:"#fff"}}>
                  <option value="admin">Админ</option>
                  <option value="manager">Менежер</option>
                  <option value="booking">Booking Manager</option>
                  <option value="finance">Санхүүгийн менежер</option>
                </select>
              </div>
              <button onClick={()=>{
                if (!adminNewUser.trim()||!adminNewPass.trim()) { setSaveMsg("⚠ Нэр, нууц үг бөглөнө үү"); setTimeout(()=>setSaveMsg(""),3000); return; }
                if (users.find(u=>u.username===adminNewUser.trim())) { setSaveMsg("⚠ Энэ нэр бүртгэлтэй байна"); setTimeout(()=>setSaveMsg(""),3000); return; }
                const nu = [...users, { username:adminNewUser.trim(), password:adminNewPass.trim(), role:adminNewRole, label:adminNewLabel.trim()||adminNewUser.trim() }];
                saveUsers(nu);
                setAdminNewUser(""); setAdminNewPass(""); setAdminNewLabel("");
                setSaveMsg("✓ Хэрэглэгч нэмэгдлээ"); setTimeout(()=>setSaveMsg(""),3000);
              }} style={{padding:"8px 20px",background:C.wine,color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:700,fontSize:12,whiteSpace:"nowrap"}}>+ Нэмэх</button>
            </div>
          </div>

          {/* Users list */}
          {users.map((u,i) => (
            <div key={u.username} className="fu" style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,padding:"16px 20px",marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center",animationDelay:`${i*0.04}s`}}>
              <div style={{display:"flex",alignItems:"center",gap:12}}>
                <div style={{width:36,height:36,borderRadius:10,background:u.role==="manager"?C.wine:u.role==="finance"?"#059669":C.blue,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontWeight:700,fontSize:14}}>{(u.label||u.username).charAt(0).toUpperCase()}</div>
                <div>
                  <div style={{fontWeight:700,fontSize:14,color:C.dark}}>{u.label}</div>
                  <div style={{fontSize:11,color:C.muted}}>@{u.username} · {u.role==="admin"?"Админ":u.role==="manager"?"Менежер":u.role==="finance"?"Санхүү":"Booking"}</div>
                </div>
              </div>
              <div style={{display:"flex",gap:8,alignItems:"center"}}>
                <span style={{fontSize:9,padding:"3px 10px",borderRadius:10,background:u.role==="manager"?C.wine:u.role==="finance"?"#059669":C.blue,color:"#fff",fontWeight:700}}>{u.role==="manager"?"ADMIN":u.role==="finance"?"FINANCE":"BOOKING"}</span>
                {u.username !== currentUser.username && (
                  <button onClick={()=>{
                    if (!window.confirm(`"${u.label}" хэрэглэгчийг устгах уу?`)) return;
                    saveUsers(users.filter(x=>x.username!==u.username));
                    setSaveMsg("✓ Устгагдлаа"); setTimeout(()=>setSaveMsg(""),3000);
                  }} style={{padding:"4px 12px",background:C.redBg,color:C.red,border:`1px solid ${C.redBd}`,borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:600,fontSize:10}}>Устгах</button>
                )}
              </div>
            </div>
          ))}

          {saveMsg && <div style={{marginTop:16,padding:"10px 16px",background:saveMsg.includes("✓")?C.greenBg:C.redBg,border:`1px solid ${saveMsg.includes("✓")?C.greenBd:C.redBd}`,borderRadius:10,fontSize:12,color:saveMsg.includes("✓")?C.green:C.red,fontWeight:600}}>{saveMsg}</div>}
        </div>
      </div>
    </>
  );

  /* ═══════════════════════════════════════════
     APPROVALS (Pending Edits) - Manager only
     ═══════════════════════════════════════════ */
  if (page === "approvals" && isManager) {
    const pendingInvs = invoices.filter(i => i.pendingEdit);
    const overdueInvs = invoices.filter(inv => {
      if (inv.paymentStatus === "paid") return false;
      if (inv.installEnabled && inv.installments?.length) {
        return inv.installments.some(inst => !inst.paid && inst.date && new Date(inst.date) < new Date());
      }
      return inv.dueDate && new Date(inv.dueDate) < new Date();
    });
    return (
      <>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
          *{box-sizing:border-box;margin:0;padding:0}
          @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
          .fu{animation:fadeUp .35s ease both}
        `}</style>
        <div style={{minHeight:"100vh",background:C.cream,fontFamily:"'Outfit',sans-serif"}}>
          <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <button onClick={()=>setPage("trips")} style={{background:"none",border:"none",fontSize:14,color:C.muted,cursor:"pointer",fontFamily:"'Outfit'"}}>← Хянах самбар</button>
            <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark}}>⏳ Батлах & Хугацаа хэтэрсэн</h2>
            <div/>
          </div>
          <div style={{maxWidth:800,margin:"0 auto",padding:"28px 20px"}}>
            {/* Pending edits */}
            <div style={{marginBottom:32}}>
              <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:C.dark,marginBottom:16}}>⏳ Хүлээгдэж буй засварууд ({pendingInvs.length})</h3>
              {pendingInvs.length === 0 && <div style={{padding:40,textAlign:"center",color:C.light,fontSize:13}}>Хүлээгдэж буй засвар алга ✓</div>}
              {pendingInvs.map((inv,i) => {
                const trip = trips.find(t=>t.code===inv.tripCode);
                const pe = inv.pendingEdit;
                return (
                  <div key={inv.id} className="fu" style={{background:"#fff",borderRadius:14,border:`1px solid #F59E0B44`,padding:"18px 22px",marginBottom:10,animationDelay:`${i*0.04}s`}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:10}}>
                      <div>
                        <div style={{fontWeight:700,fontSize:15,color:C.dark}}>{inv.clientName}</div>
                        <div style={{fontSize:11,color:C.muted}}>{inv.refCode||"—"} · {trip?.destName||inv.dest} · {trip?.date||""}</div>
                      </div>
                      <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark}}>{fmt(inv.total)}</div>
                    </div>
                    <div style={{padding:"10px 14px",background:"#FEF3C7",borderRadius:8,marginBottom:10}}>
                      <div style={{fontSize:10,fontWeight:700,color:"#D97706",marginBottom:4}}>Засварлагч: {pe.by} · {new Date(pe.date).toLocaleDateString("mn")}</div>
                      <div style={{fontSize:11,color:"#92400E"}}>{pe.changes?.join(" · ")}</div>
                    </div>
                    <div style={{display:"flex",gap:8}}>
                      <button onClick={()=>approvePendingEdit(inv)} style={{flex:1,padding:"8px 0",background:C.green,color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:700,fontSize:12}}>✓ Батлах</button>
                      <button onClick={()=>rejectPendingEdit(inv)} style={{flex:1,padding:"8px 0",background:C.red,color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:700,fontSize:12}}>✕ Татгалзах</button>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Overdue payments */}
            <div>
              <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:C.dark,marginBottom:16}}>🔴 Хугацаа хэтэрсэн төлбөрүүд ({overdueInvs.length})</h3>
              {overdueInvs.length === 0 && <div style={{padding:40,textAlign:"center",color:C.light,fontSize:13}}>Хугацаа хэтэрсэн төлбөр алга ✓</div>}
              {overdueInvs.map((inv,i) => {
                const trip = trips.find(t=>t.code===inv.tripCode);
                const paidAmt = inv.payments?.length ? inv.payments.filter(p=>!p.reversed).reduce((s,p)=>s+p.amount,0) : (inv.installEnabled && inv.installments?.length ? inv.installments.filter(x=>x.paid).reduce((s,x)=>s+x.amount,0) : (inv.paymentStatus==="paid"?inv.total:0));
                const overdueDays = inv.dueDate ? Math.floor((new Date()-new Date(inv.dueDate))/(1000*60*60*24)) : 0;
                return (
                  <div key={inv.id} className="fu" style={{background:"#fff",borderRadius:14,border:`1px solid ${C.redBd}`,padding:"16px 20px",marginBottom:8,animationDelay:`${i*0.04}s`,cursor:"pointer"}} onClick={()=>{setSelectedTrip(trip);setPage("trip-detail")}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                      <div>
                        <div style={{fontWeight:700,fontSize:14,color:C.dark}}>{inv.clientName}</div>
                        <div style={{fontSize:11,color:C.muted}}>{inv.refCode||"—"} · {trip?.destName||inv.dest} · {trip?.date||""}</div>
                      </div>
                      <div style={{textAlign:"right"}}>
                        <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:18,fontWeight:700,color:C.red}}>{fmt(inv.total - paidAmt)}</div>
                        {overdueDays > 0 && <div style={{fontSize:10,color:C.red,fontWeight:700}}>{overdueDays} хоног хэтэрсэн</div>}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {saveMsg && <div style={{position:"fixed",bottom:20,left:"50%",transform:"translateX(-50%)",padding:"10px 24px",background:saveMsg.includes("✓")?"#065F46":"#991B1B",color:"#fff",borderRadius:12,fontSize:13,fontWeight:600,zIndex:100}}>{saveMsg}</div>}
          </div>
        </div>
      </>
    );
  }

  /* ═══════════════════════════════════════════
     FINANCE PAGE
     ═══════════════════════════════════════════ */
  if (page === "finance" && (isFinance || isAdmin)) {
    const fSearchQ = invSearchQ;
    const today = new Date().toISOString().split("T")[0];

    // Payment recording
    const recordPayment = async (inv, amount, note) => {
      if (!isFinance && !isAdmin) { setSaveMsg("⚠ Зөвхөн санхүүгийн менежер төлбөр бүртгэх эрхтэй"); setTimeout(()=>setSaveMsg(""),3000); return; }
      if (!amount || amount <= 0) return;
      const payment = {
        date: new Date().toISOString(),
        amount: Math.round(amount),
        by: currentUser.username,
        byLabel: currentUser.label,
        note: note || "",
      };
      const updated = { ...inv };
      if (!updated.payments) updated.payments = [];
      updated.payments.push(payment);
      // Recalculate payment status
      const totalPaid = updated.payments.reduce((s, p) => s + p.amount, 0);
      if (totalPaid >= updated.total) {
        updated.paymentStatus = "paid";
      } else if (totalPaid > 0) {
        updated.paymentStatus = "partial";
      } else {
        updated.paymentStatus = "pending";
      }
      // If installment, auto-mark installments as paid
      if (updated.installEnabled && updated.installments?.length) {
        let remaining = totalPaid;
        updated.installments.forEach(inst => {
          if (remaining >= inst.amount) {
            inst.paid = true;
            inst.paidDate = inst.paidDate || new Date().toISOString();
            remaining -= inst.amount;
          } else {
            inst.paid = false;
          }
        });
      }
      try { await saveInv(updated); } catch(e) {}
      setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
      setSaveMsg("✓ Төлбөр бүртгэгдлээ!"); setTimeout(() => setSaveMsg(""), 3000);
    };

    const reversePayment = async (inv, payIdx) => {
      if (!isFinance && !isAdmin) { setSaveMsg("⚠ Зөвхөн санхүүгийн менежер төлбөр буцаах эрхтэй"); setTimeout(()=>setSaveMsg(""),3000); return; }
      const p = inv.payments[payIdx];
      if (!window.confirm(`${fmt(p.amount)} төлбөрийг буцаах уу?`)) return;
      const updated = { ...inv };
      // Mark payment as reversed, keep in history
      updated.payments = [...inv.payments];
      updated.payments[payIdx] = { ...p, reversed: true, reversedAt: new Date().toISOString(), reversedBy: currentUser.username, reversedByLabel: currentUser.label };
      // Recalculate from non-reversed payments
      const activePmts = updated.payments.filter(pm => !pm.reversed);
      const totalPaid = activePmts.reduce((s, pm) => s + pm.amount, 0);
      if (totalPaid >= updated.total) { updated.paymentStatus = "paid"; }
      else if (totalPaid > 0) { updated.paymentStatus = "partial"; }
      else { updated.paymentStatus = "pending"; }
      // Recalc installments
      if (updated.installEnabled && updated.installments?.length) {
        let remaining = totalPaid;
        updated.installments.forEach(inst => {
          if (remaining >= inst.amount) { inst.paid = true; remaining -= inst.amount; }
          else { inst.paid = false; inst.paidDate = null; }
        });
      }
      const editHistory = [...(updated.editHistory || []), { date: new Date().toISOString(), changes: [`Төлбөр буцаав: ${fmt(p.amount)} (${currentUser.label})`] }];
      updated.editHistory = editHistory;
      try { await saveInv(updated); } catch(e) {}
      setInvoices(prev => prev.map(i => i.id === inv.id ? updated : i));
      setSaveMsg("✓ Төлбөр буцаагдлаа"); setTimeout(() => setSaveMsg(""), 3000);
    };

    // Filter invoices
    const statusFilter = expandedInv; // reuse state for filter: "all" | "pending" | "partial" | "paid" | "overdue"
    const setStatusFilter = setExpandedInv;
    const allInvs = [...activeInvoices].sort((a, b) => (b.savedAt || "").localeCompare(a.savedAt || ""));
    const q = fSearchQ.toLowerCase().trim();
    // Get unique destinations and trip codes for filter
    const finDests = [...new Set(allInvs.map(i => i.dest).filter(Boolean))];
    const finTripCodes = [...new Set(allInvs.map(i => i.tripCode).filter(Boolean))];
    let filtered = allInvs;
    if (q) {
      filtered = filtered.filter(inv =>
        (inv.clientName || "").toLowerCase().includes(q) ||
        (inv.clientPhone || "").includes(q) ||
        (inv.tripCode || "").toLowerCase().includes(q) ||
        (inv.refCode || inv.txnValue || "").toLowerCase().includes(q) ||
        (inv.destName || inv.dest || "").toLowerCase().includes(q) ||
        (inv.createdByLabel || inv.createdBy || "").toLowerCase().includes(q)
      );
    }
    if (statusFilter === "pending") filtered = filtered.filter(i => i.paymentStatus === "pending");
    else if (statusFilter === "partial") filtered = filtered.filter(i => i.paymentStatus === "partial");
    else if (statusFilter === "paid") filtered = filtered.filter(i => i.paymentStatus === "paid");
    else if (statusFilter === "overdue") filtered = filtered.filter(i => {
      if (i.paymentStatus === "paid") return false;
      if (i.installEnabled && i.installments?.length) return i.installments.some(inst => !inst.paid && inst.date && inst.date < today);
      return i.dueDate && i.dueDate < today && i.paymentStatus !== "paid";
    });
    if (finDestFilter) filtered = filtered.filter(i => i.dest === finDestFilter);
    if (finTripFilter) filtered = filtered.filter(i => i.tripCode === finTripFilter);

    // Stats
    const totalInvoiced = allInvs.reduce((s, i) => s + (i.total || 0), 0);
    const totalPaidAmt = allInvs.reduce((s, inv) => {
      if (inv.payments?.length) return s + inv.payments.filter(p=>!p.reversed).reduce((ss, p) => ss + p.amount, 0);
      if (inv.paymentStatus === "paid") return s + inv.total;
      if (inv.installEnabled && inv.installments?.length) return s + inv.installments.filter(x => x.paid).reduce((ss, x) => ss + x.amount, 0);
      return s;
    }, 0);
    const overdueCount = allInvs.filter(i => {
      if (i.paymentStatus === "paid") return false;
      if (i.installEnabled && i.installments?.length) return i.installments.some(inst => !inst.paid && inst.date && inst.date < today);
      return i.dueDate && i.dueDate < today;
    }).length;

    return (
      <>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
          *{box-sizing:border-box;margin:0;padding:0}
          input:focus,select:focus{border-color:#059669!important;box-shadow:0 0 0 3px #05966918!important}
          @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
          .fu{animation:fadeUp .35s ease both}
        `}</style>
        <div style={{minHeight:"100vh",background:"linear-gradient(170deg, #F0FDF4 0%, #F5F0EE 40%, #F0FDF4 100%)",fontFamily:"'Outfit',sans-serif"}}>
          {/* Nav */}
          <div style={{background:"#ECFDF5",borderBottom:"2px solid #D1FAE5",padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:50}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <img src={LOGO_B64} alt="" style={{height:28}} />
              <span style={{color:"#059669",fontWeight:600,fontSize:13,opacity:.3}}>|</span>
              <span style={{color:C.text,fontWeight:600,fontSize:13}}>{currentUser.label}</span>
              <span style={{fontSize:9,padding:"2px 8px",borderRadius:10,background:"#059669",color:"#fff",fontWeight:700}}>FINANCE</span>
            </div>
            <div style={{display:"flex",gap:8,alignItems:"center"}}>
              {(isAdmin || isFinance) && <button onClick={()=>setPage("trips")} style={btnS}>📋 Booking</button>}
              <button onClick={loadAll} style={btnS}>↻ Шинэчлэх</button>
              <button onClick={()=>setCurrentUser(null)} style={{...btnS,color:C.red,borderColor:C.red+"44"}}>Гарах</button>
            </div>
          </div>

          <div style={{maxWidth:1200,margin:"0 auto",padding:"28px 20px 80px"}}>
            {/* KPI */}
            <div className="fu" style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:10,marginBottom:20}}>
              {[
                { label:"Нийт нэхэмжлэл", value:fmt(totalInvoiced), sub:`${allInvs.length} ширхэг`, icon:"📋", color:C.dark },
                { label:"Төлсөн", value:fmt(totalPaidAmt), sub:totalInvoiced>0?`${Math.round(totalPaidAmt/totalInvoiced*100)}%`:"0%", icon:"✅", color:"#059669" },
                { label:"Үлдэгдэл", value:fmt(totalInvoiced - totalPaidAmt), sub:`${allInvs.filter(i=>i.paymentStatus!=="paid").length} нэхэмжлэл`, icon:"⏳", color:C.red },
                { label:"Хугацаа хэтэрсэн", value:overdueCount, sub:"анхааруулга", icon:"🔴", color:C.red },
              ].map((k, i) => (
                <div key={i} style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,padding:"14px 16px"}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                    <span style={{fontSize:8,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light}}>{k.label}</span>
                    <span style={{fontSize:16}}>{k.icon}</span>
                  </div>
                  <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:k.color}}>{k.value}</div>
                  {k.sub && <div style={{fontSize:10,color:C.muted,marginTop:2}}>{k.sub}</div>}
                </div>
              ))}
            </div>

            {/* Overdue alert */}
            {overdueCount > 0 && (
              <div className="fu" style={{marginBottom:16,padding:"12px 18px",background:"#FEF2F2",border:"1px solid #FCA5A544",borderRadius:12,display:"flex",alignItems:"center",gap:10,animationDelay:".1s"}}>
                <span style={{fontSize:18}}>🔴</span>
                <div style={{fontSize:12,color:C.red,fontWeight:600}}>{overdueCount} нэхэмжлэлийн төлбөрийн хугацаа хэтэрсэн байна!</div>
                <button onClick={()=>setStatusFilter("overdue")} style={{marginLeft:"auto",padding:"4px 14px",background:C.red,color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontWeight:600,fontSize:10,fontFamily:"'Outfit'"}}>Харах</button>
              </div>
            )}

            {/* Search + Filter */}
            <div className="fu" style={{display:"flex",gap:10,marginBottom:10,alignItems:"center",animationDelay:".12s",flexWrap:"wrap"}}>
              <input placeholder="🔍 Нэр, утас, код, чиглэл хайх..." value={invSearchQ} onChange={e=>setInvSearchQ(e.target.value)} style={{...inp,flex:1,minWidth:200,borderRadius:20,padding:"10px 18px"}} />
              <select value={finDestFilter||""} onChange={e=>{ setFinDestFilter(e.target.value||null); setFinTripFilter(null); }} style={{...inp,borderRadius:20,padding:"8px 14px",fontSize:12,minWidth:120}}>
                <option value="">📍 Бүх чиглэл</option>
                {finDests.map(d => <option key={d} value={d}>{destCodes[d]?.name || d}</option>)}
              </select>
              {finDestFilter && (() => {
                const tripCodes = finTripCodes.filter(tc => tc.startsWith(finDestFilter));
                return tripCodes.length > 0 ? (
                  <select value={finTripFilter||""} onChange={e=>setFinTripFilter(e.target.value||null)} style={{...inp,borderRadius:20,padding:"8px 14px",fontSize:12,minWidth:160}}>
                    <option value="">Бүх аялал</option>
                    {tripCodes.map(tc => <option key={tc} value={tc}>{tc}</option>)}
                  </select>
                ) : null;
              })()}
            </div>
            <div className="fu" style={{display:"flex",gap:4,marginBottom:16,animationDelay:".14s",flexWrap:"wrap"}}>
              {[
                {v:null,l:"Бүгд",c:C.dark},
                {v:"pending",l:"Хүлээгдэж буй",c:C.orange},
                {v:"partial",l:"Хэсэгчлэн",c:C.blue},
                {v:"paid",l:"Төлсөн",c:"#059669"},
                {v:"overdue",l:"🔴 Хугацаа хэтэрсэн",c:C.red},
              ].map(f => (
                <button key={f.l} onClick={()=>setStatusFilter(f.v)} style={{padding:"7px 14px",background:statusFilter===f.v?f.c:"#fff",color:statusFilter===f.v?"#fff":f.c,border:`1.5px solid ${statusFilter===f.v?f.c:C.border}`,borderRadius:20,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:statusFilter===f.v?700:500,fontSize:11,transition:"all .15s",whiteSpace:"nowrap"}}>{f.l}</button>
              ))}
              {(finDestFilter || finTripFilter || statusFilter) && (
                <button onClick={()=>{setFinDestFilter(null);setFinTripFilter(null);setStatusFilter(null);setInvSearchQ("")}} style={{padding:"7px 14px",background:"#F3F4F6",color:C.muted,border:`1px solid ${C.border}`,borderRadius:20,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:500,fontSize:11}}>✕ Цэвэрлэх</button>
              )}
            </div>

            {/* Invoice list */}
            <div style={{background:"#fff",borderRadius:14,border:`1px solid ${C.border}`,overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"32px 1fr 130px 120px 120px 100px",padding:"10px 16px",background:"#ECFDF5",fontSize:8.5,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,borderBottom:`1px solid ${C.border}`}}>
                <div>#</div>
                <div>Зорчигч / Код</div>
                <div style={{textAlign:"right"}}>Нэхэмжлэл</div>
                <div style={{textAlign:"right"}}>Төлсөн</div>
                <div style={{textAlign:"right"}}>Үлдэгдэл</div>
                <div style={{textAlign:"center"}}>Үйлдэл</div>
              </div>
              {filtered.length === 0 && <div style={{padding:30,textAlign:"center",color:C.light,fontSize:12}}>Олдсонгүй</div>}
              {filtered.map((inv, i) => {
                const paidAmt = inv.payments?.length ? inv.payments.filter(p=>!p.reversed).reduce((s, p) => s + p.amount, 0) : (inv.installEnabled && inv.installments?.length ? inv.installments.filter(x => x.paid).reduce((s, x) => s + x.amount, 0) : (inv.paymentStatus === "paid" ? inv.total : 0));
                const outstanding = inv.total - paidAmt;
                const isExp = selectedInvoice?.id === inv.id;
                const isOverdue = inv.paymentStatus !== "paid" && ((inv.dueDate && inv.dueDate < today) || (inv.installEnabled && inv.installments?.some(inst => !inst.paid && inst.date && inst.date < today)));
                const trip = trips.find(t => t.code === inv.tripCode);

                return (
                  <div key={inv.id}>
                    <div onClick={() => setSelectedInvoice(isExp ? null : inv)} style={{display:"grid",gridTemplateColumns:"32px 1fr 130px 120px 120px 100px",padding:"10px 16px",alignItems:"center",borderBottom:`1px solid ${C.border}22`,background:isOverdue?"#FEF2F266":i%2===0?"#fff":"#FAFAFA",cursor:"pointer",transition:"background .15s"}}
                      onMouseEnter={e => e.currentTarget.style.background = "#ECFDF5"}
                      onMouseLeave={e => e.currentTarget.style.background = isOverdue ? "#FEF2F266" : i % 2 === 0 ? "#fff" : "#FAFAFA"}>
                      <div style={{fontSize:11,color:C.light,fontWeight:600}}>{String(i + 1).padStart(2, "0")}</div>
                      <div>
                        <div style={{display:"flex",alignItems:"center",gap:6}}>
                          <span style={{fontWeight:600,fontSize:13,color:C.dark}}>{inv.clientName}</span>
                          <span style={{fontSize:10,color:C.muted}}>{inv.clientPhone}</span>
                          {isOverdue && <span style={{fontSize:8,padding:"1px 5px",borderRadius:6,background:"#FEE2E2",color:C.red,fontWeight:700}}>ХЭТЭРСЭН</span>}
                        </div>
                        <div style={{fontSize:10,color:C.muted,marginTop:2}}>
                          <span style={{fontFamily:"monospace",color:C.gold,fontWeight:600}}>{inv.refCode || "—"}</span>
                          <span style={{margin:"0 6px"}}>·</span>
                          <span>{trip?.destName || inv.dest}</span>
                          <span style={{margin:"0 6px"}}>·</span>
                          <span>{inv.createdByLabel || inv.createdBy || ""}</span>
                        </div>
                      </div>
                      <div style={{textAlign:"right",fontWeight:700,fontSize:13,color:C.dark}}>{fmt(inv.total)}</div>
                      <div style={{textAlign:"right",fontWeight:700,fontSize:13,color:paidAmt > 0 ? "#059669" : C.muted}}>{fmt(paidAmt)}</div>
                      <div style={{textAlign:"right",fontWeight:700,fontSize:13,color:outstanding > 0 ? C.red : "#059669"}}>{fmt(outstanding)}</div>
                      <div style={{textAlign:"center"}}><span style={{...badge(inv.paymentStatus),fontSize:9,padding:"2px 8px"}}>{statusInfo[inv.paymentStatus]?.icon} {inv.paymentStatus === "partial" ? Math.round(paidAmt / inv.total * 100) + "%" : statusInfo[inv.paymentStatus]?.label}</span></div>
                    </div>

                    {/* Expanded payment panel */}
                    {isExp && (
                      <div style={{padding:"16px 16px 16px 48px",background:"#F0FDF4",borderBottom:`1px solid ${C.border}44`}}>
                        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:20}}>
                          {/* Left: Invoice info + installments */}
                          <div>
                            <div style={{fontSize:9,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,marginBottom:8}}>НЭХЭМЖЛЭЛИЙН МЭДЭЭЛЭЛ</div>
                            <div style={{fontSize:11,marginBottom:4}}><span style={{color:C.light}}>Гүйлгээний утга:</span> <span style={{fontFamily:"monospace",fontWeight:600}}>{inv.txnValue}</span></div>
                            <div style={{fontSize:11,marginBottom:4}}><span style={{color:C.light}}>Огноо:</span> {inv.invDate} <span style={{color:C.light,marginLeft:10}}>Хугацаа:</span> {inv.dueDate || "—"}</div>
                            <div style={{fontSize:11,marginBottom:8}}><span style={{color:C.light}}>Бүртгэсэн:</span> {inv.createdByLabel || inv.createdBy || "—"}</div>

                            {/* Items */}
                            <div style={{fontSize:10,color:C.muted,marginBottom:8}}>
                              {inv.items?.map((it, j) => {
                                const tIcons = {flight: "🛫", ground: "🏨", package: "📦", infant: "👶"};
                                return <div key={j}>{tIcons[it.type] || "📦"} {it.description} ({it.qty} хүн × {fmt(it.rate)})</div>;
                              })}
                            </div>

                            {/* Installments */}
                            {inv.installEnabled && inv.installments?.length > 0 && (
                              <div style={{padding:"10px 12px",background:"#fff",borderRadius:10,border:`1px solid ${C.border}`}}>
                                <div style={{fontSize:9,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,marginBottom:6}}>ТӨЛБӨРИЙН ХУВААРЬ</div>
                                {inv.installments.map((inst, idx) => {
                                  const isOD = !inst.paid && inst.date && inst.date < today;
                                  return (
                                    <div key={idx} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"5px 0",fontSize:11,borderBottom:idx < inv.installments.length - 1 ? `1px solid ${C.border}33` : "none"}}>
                                      <div style={{display:"flex",gap:6,alignItems:"center"}}>
                                        <span style={{width:16,height:16,borderRadius:4,border:`2px solid ${inst.paid ? "#059669" : C.border}`,background:inst.paid ? "#059669" : "#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:9,fontWeight:700}}>{inst.paid ? "✓" : ""}</span>
                                        <span style={{color:inst.paid ? "#059669" : C.text,fontWeight:600,textDecoration:inst.paid ? "line-through" : "none"}}>{inst.label}</span>
                                        <span style={{color:C.muted,fontSize:10}}>{inst.date || "—"}</span>
                                        {isOD && <span style={{fontSize:8,padding:"1px 5px",borderRadius:6,background:"#FEE2E2",color:C.red,fontWeight:700}}>ХЭТЭРСЭН</span>}
                                      </div>
                                      <span style={{fontWeight:700,color:inst.paid ? "#059669" : C.dark}}>{fmt(inst.amount)}</span>
                                    </div>
                                  );
                                })}
                              </div>
                            )}
                          </div>

                          {/* Right: Payment recording + history */}
                          <div>
                            {/* Record payment */}
                            {outstanding > 0 && (
                              <div style={{padding:"14px 16px",background:"#fff",borderRadius:10,border:`1px solid #059669`,marginBottom:12}}>
                                <div style={{fontSize:9,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:"#059669",marginBottom:8}}>💰 ТӨЛБӨР БҮРТГЭХ</div>
                                <div style={{display:"flex",gap:8,marginBottom:8}}>
                                  <input id={`pay-amt-${inv.id}`} type="number" min={1} max={outstanding} placeholder={`Дүн (max ${fmt(outstanding)})`} style={{...inp,flex:1,padding:"8px 12px",fontSize:12}} />
                                </div>
                                <div style={{display:"flex",gap:8,marginBottom:8}}>
                                  <input id={`pay-note-${inv.id}`} placeholder="Тэмдэглэл (банкны лавлагаа г.м.)" style={{...inp,flex:1,padding:"8px 12px",fontSize:11}} />
                                </div>
                                <div style={{display:"flex",gap:8}}>
                                  <button onClick={() => {
                                    const amtEl = document.getElementById(`pay-amt-${inv.id}`);
                                    const noteEl = document.getElementById(`pay-note-${inv.id}`);
                                    const amt = parseFloat(amtEl?.value);
                                    if (!amt || amt <= 0) { setSaveMsg("⚠ Дүн оруулна уу"); setTimeout(() => setSaveMsg(""), 3000); return; }
                                    if (amt > outstanding) { setSaveMsg("⚠ Үлдэгдэлээс их байна"); setTimeout(() => setSaveMsg(""), 3000); return; }
                                    recordPayment(inv, amt, noteEl?.value || "");
                                    if (amtEl) amtEl.value = "";
                                    if (noteEl) noteEl.value = "";
                                  }} style={{padding:"8px 20px",background:"#059669",color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:700,fontSize:12}}>
                                    💰 Бүртгэх
                                  </button>
                                  <button onClick={() => {
                                    const noteEl = document.getElementById(`pay-note-${inv.id}`);
                                    recordPayment(inv, outstanding, noteEl?.value || "Бүрэн төлбөр");
                                  }} style={{padding:"8px 16px",background:"#fff",color:"#059669",border:"1.5px solid #059669",borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:600,fontSize:11}}>
                                    Бүрэн төлөх ({fmt(outstanding)})
                                  </button>
                                </div>
                              </div>
                            )}

                            {inv.paymentStatus === "paid" && (
                              <div style={{padding:"12px 16px",background:"#ECFDF5",borderRadius:10,border:"1px solid #A7F3D0",marginBottom:12,textAlign:"center"}}>
                                <span style={{fontSize:20}}>✅</span>
                                <div style={{fontSize:13,fontWeight:700,color:"#059669",marginTop:4}}>Бүрэн төлсөн</div>
                              </div>
                            )}

                            {/* Payment history */}
                            {inv.payments?.length > 0 && (
                              <div style={{padding:"10px 12px",background:"#fff",borderRadius:10,border:`1px solid ${C.border}`}}>
                                <div style={{fontSize:9,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,marginBottom:6}}>ТӨЛБӨРИЙН ТҮҮХ</div>
                                {inv.payments.map((p, idx) => (
                                  <div key={idx} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"5px 0",fontSize:11,borderBottom:idx < inv.payments.length - 1 ? `1px solid ${C.border}33` : "none",opacity:p.reversed?0.5:1}}>
                                    <div>
                                      <span style={{color:C.muted}}>{new Date(p.date).toLocaleDateString("mn")}</span>
                                      <span style={{marginLeft:8,color:p.reversed?"#991B1B":"#059669",fontWeight:600}}>{p.byLabel || p.by}</span>
                                      {p.note && <span style={{marginLeft:8,color:C.muted,fontSize:10}}>({p.note})</span>}
                                      {p.reversed && <span style={{marginLeft:6,fontSize:9,padding:"1px 6px",borderRadius:6,background:"#FEE2E2",color:C.red,fontWeight:700}}>БУЦААСАН</span>}
                                      {p.reversed && <span style={{marginLeft:4,color:C.muted,fontSize:9}}>({p.reversedByLabel} · {new Date(p.reversedAt).toLocaleDateString("mn")})</span>}
                                    </div>
                                    <div style={{display:"flex",alignItems:"center",gap:6}}>
                                      <span style={{fontWeight:700,color:p.reversed?C.red:"#059669",textDecoration:p.reversed?"line-through":"none"}}>{p.reversed?"-":"+"}{fmt(p.amount)}</span>
                                      {!p.reversed && <button onClick={()=>reversePayment(inv,idx)} title="Буцаах" style={{width:22,height:22,background:"#FEE2E2",color:C.red,border:"none",borderRadius:5,cursor:"pointer",fontSize:10,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700}}>↩</button>}
                                    </div>
                                  </div>
                                ))}
                                <div style={{marginTop:6,paddingTop:6,borderTop:`1px solid ${C.border}`,display:"flex",justifyContent:"space-between",fontSize:11,fontWeight:700}}>
                                  <span style={{color:C.dark}}>Нийт төлсөн:</span>
                                  <span style={{color:"#059669"}}>{fmt(paidAmt)}</span>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
          {saveMsg && <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"12px 28px",background:saveMsg.includes("✓") ? "#059669" : C.red,color:"#fff",borderRadius:50,fontFamily:"'Outfit'",fontWeight:600,fontSize:13,boxShadow:"0 4px 24px rgba(0,0,0,.2)",zIndex:100}}>{saveMsg}</div>}
        </div>
      </>
    );
  }

  /* ═══════════════════════════════════════════
     RECYCLE BIN (Хогийн сав)
     ═══════════════════════════════════════════ */
  if (page === "recycle") return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        .fu { animation: fu .4s ease both; }
        @keyframes fu { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
      `}</style>
      <div style={{minHeight:"100vh",background:"#FAFAF9",fontFamily:"'Outfit',sans-serif"}}>
        <div style={{maxWidth:900,margin:"0 auto",padding:"40px 20px 80px"}}>
          <div className="fu" style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:28}}>
            <div>
              <button onClick={()=>setPage("trips")} style={{...btnS,marginBottom:12}}>← Буцах</button>
              <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:700,color:C.dark}}>🗑 Хогийн сав</h2>
              <p style={{color:C.muted,fontSize:13,marginTop:4}}>Устгагдсан аялал, нэхэмжлэлүүд энд хадгалагдана. Сэргээх эсвэл бүрмөсөн устгах боломжтой.</p>
            </div>
          </div>

          {deletedTrips.length === 0 && deletedInvoices.length === 0 && (
            <div className="fu" style={{textAlign:"center",padding:"60px 20px",color:C.muted}}>
              <div style={{fontSize:48,marginBottom:12}}>✨</div>
              <div style={{fontSize:15,fontWeight:600}}>Хогийн сав хоосон байна</div>
            </div>
          )}

          {deletedTrips.length > 0 && (
            <div className="fu" style={{marginBottom:32}}>
              <div style={{fontSize:11,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.wine,marginBottom:12}}>Устгагдсан аялалууд ({deletedTrips.length})</div>
              {deletedTrips.map(t => {
                const invCount = invoices.filter(i => i.tripCode === t.code).length;
                return (
                  <div key={t.code} style={{background:"#fff",borderRadius:14,padding:"16px 20px",marginBottom:8,border:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                    <div>
                      <div style={{fontWeight:700,fontSize:14,color:C.dark}}>{t.code} <span style={{fontSize:12,color:C.muted,fontWeight:400}}>— {t.destName || t.dest}</span></div>
                      <div style={{fontSize:11,color:C.muted,marginTop:2}}>
                        Огноо: {t.date} · {invCount} нэхэмжлэл · Устгасан: {t.deletedBy} · {t.deletedAt ? new Date(t.deletedAt).toLocaleDateString("mn-MN") : ""}
                      </div>
                    </div>
                    <div style={{display:"flex",gap:8}}>
                      <button onClick={()=>restoreTrip(t)} style={{...btnS,color:"#059669",borderColor:"#059669"+"44"}}>♻ Сэргээх</button>
                      <button onClick={()=>permanentDeleteTrip(t)} style={{...btnS,color:C.red,borderColor:C.red+"44"}}>✕ Бүрмөсөн</button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {deletedInvoices.length > 0 && (
            <div className="fu" style={{animationDelay:".05s"}}>
              <div style={{fontSize:11,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.wine,marginBottom:12}}>Устгагдсан нэхэмжлэлүүд ({deletedInvoices.length})</div>
              {deletedInvoices.map(inv => (
                <div key={inv.id} style={{background:"#fff",borderRadius:14,padding:"16px 20px",marginBottom:8,border:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <div>
                    <div style={{fontWeight:700,fontSize:14,color:C.dark}}>{inv.clientName} <span style={{fontSize:12,color:C.muted,fontWeight:400}}>— {inv.refCode}</span></div>
                    <div style={{fontSize:11,color:C.muted,marginTop:2}}>
                      {inv.tripCode} · {fmt(inv.total)} · Устгасан: {inv.deletedBy} · {inv.deletedAt ? new Date(inv.deletedAt).toLocaleDateString("mn-MN") : ""}
                    </div>
                  </div>
                  <div style={{display:"flex",gap:8}}>
                    <button onClick={()=>restoreInvoice(inv)} style={{...btnS,color:"#059669",borderColor:"#059669"+"44"}}>♻ Сэргээх</button>
                    <button onClick={()=>permanentDeleteInvoice(inv)} style={{...btnS,color:C.red,borderColor:C.red+"44"}}>✕ Бүрмөсөн</button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
        {saveMsg && <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"12px 28px",background:saveMsg.includes("✓")?C.green:C.red,color:"#fff",borderRadius:50,fontFamily:"'Outfit'",fontWeight:600,fontSize:13,boxShadow:"0 4px 24px rgba(0,0,0,.2)",zIndex:100}}>{saveMsg}</div>}
      </div>
    </>
  );

  /* ═══════════════════════════════════════════
     SETTINGS (Destination Codes Manager)
     ═══════════════════════════════════════════ */
  if (page === "settings") return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}
        input:focus,select:focus{border-color:${C.wine}!important;box-shadow:0 0 0 3px ${C.wine}18!important}
        @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
        .fu{animation:fadeUp .35s ease both}
      `}</style>
      <div style={{minHeight:"100vh",background:`linear-gradient(170deg, ${C.wineBg} 0%, #F5F0EE 40%, ${C.wineBg} 100%)`,fontFamily:"'Outfit',sans-serif"}}>
        <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:50}}>
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <img src={LOGO_B64} alt="" style={{height:28,cursor:"pointer"}} onClick={()=>setPage("trips")} />
            <span style={{color:C.wine,fontWeight:600,fontSize:13,opacity:.3}}>|</span>
            <span style={{color:C.text,fontWeight:600,fontSize:13}}>⚙ Тохиргоо</span>
          </div>
          <button onClick={()=>setPage("trips")} style={btnS}>← Аялалууд</button>
        </div>

        <div style={{maxWidth:800,margin:"0 auto",padding:"28px 20px 80px"}}>
          <h1 className="fu" style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:700,color:C.dark,marginBottom:24}}>Чиглэлийн кодууд</h1>
          <p className="fu" style={{color:C.muted,fontSize:13,marginBottom:24,animationDelay:".03s"}}>Аялалын чиглэлийн кодыг нэмэх, засах, устгах боломжтой. Код нь аялалын дугаарын эхний хэсэгт ашиглагдана (жишээ: <b>SYX</b>-26021501).</p>

          {/* Add new */}
          <div className="fu" style={{...cardS,background:`linear-gradient(135deg, ${C.winePale}, ${C.goldLight})`,border:`2px solid ${C.gold}44`,padding:"24px 28px",marginBottom:24,animationDelay:".06s"}}>
            <div style={{fontSize:10,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.wine,marginBottom:14}}>Шинэ чиглэл нэмэх</div>
            <div style={{display:"grid",gridTemplateColumns:"100px 1fr 1fr auto",gap:10,alignItems:"end"}}>
              <div><label style={lbl}>Код *</label><input value={editCode} onChange={e=>setEditCode(e.target.value.toUpperCase().replace(/[^A-Z]/g,""))} maxLength={5} placeholder="SYX" style={{...inp,textTransform:"uppercase",fontWeight:700,fontFamily:"monospace",fontSize:16,textAlign:"center"}}/></div>
              <div><label style={lbl}>Чиглэлийн нэр *</label><input value={editName} onChange={e=>setEditName(e.target.value)} placeholder="Хайнан" style={inp}/></div>
              <div><label style={lbl}>Банк</label><select value={editBank} onChange={e=>setEditBank(e.target.value)} style={{...inp,cursor:"pointer"}}>{Object.keys(ALL_BANKS).map(b=><option key={b} value={b}>{b}</option>)}</select></div>
              <button onClick={addDestCode} style={{...btnP,padding:"10px 22px",whiteSpace:"nowrap"}}>+ Нэмэх</button>
            </div>
            <div style={{display:"flex",gap:5,marginTop:10}}>
              <span style={{fontSize:10,color:C.muted,marginRight:6}}>Өнгө:</span>
              {DEST_COLORS.map((clr,i)=>(
                <button key={i} onClick={()=>setEditColor(i)} style={{width:22,height:22,borderRadius:6,background:clr,border:editColor===i?`3px solid ${C.dark}`:`2px solid transparent`,cursor:"pointer",transition:"all .15s"}}/>
              ))}
            </div>
          </div>

          {/* List */}
          {Object.entries(destCodes).map(([code, info], i) => {
            const tripCount = trips.filter(t => t.dest === code).length;
            const invCount = activeInvoices.filter(inv => inv.dest === code).length;
            return (
              <div key={code} className="fu" style={{...cardS,display:"flex",justifyContent:"space-between",alignItems:"center",animationDelay:`${0.08+i*0.03}s`}}>
                <div style={{display:"flex",alignItems:"center",gap:14}}>
                  <div style={{width:48,height:48,borderRadius:12,background:info.bg,border:`2px solid ${info.color}22`,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:16,color:info.color,fontFamily:"monospace"}}>{code}</div>
                  <div>
                    <div style={{fontWeight:700,fontSize:15,color:C.dark}}>{info.name}</div>
                    <div style={{fontSize:11,color:C.muted}}>Банк: {info.bank} · {tripCount} аялал · {invCount} нэхэмжлэл</div>
                  </div>
                </div>
                <div style={{display:"flex",gap:8,alignItems:"center"}}>
                  <div style={{width:16,height:16,borderRadius:4,background:info.color}}/>
                  <button onClick={()=>{if(confirm(`"${code} — ${info.name}" устгах уу?`))removeDestCode(code)}} style={{background:"none",border:"none",color:C.light,cursor:"pointer",fontSize:12,textDecoration:"underline"}}>Устгах</button>
                </div>
              </div>
            );
          })}

          {Object.keys(destCodes).length === 0 && (
            <div style={{textAlign:"center",padding:40,color:C.light}}>Чиглэлийн код бүртгэгдээгүй</div>
          )}
        </div>
        {saveMsg && <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"12px 28px",background:saveMsg.includes("✓")?C.green:C.red,color:"#fff",borderRadius:50,fontFamily:"'Outfit'",fontWeight:600,fontSize:13,boxShadow:"0 4px 24px rgba(0,0,0,.2)",zIndex:100}}>{saveMsg}</div>}
      </div>
    </>
  );

  /* ═══════════════════════════════════════════
     ANALYTICS / REPORTS
     ═══════════════════════════════════════════ */
  if (page === "analytics") return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}
        @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
        .fu{animation:fadeUp .35s ease both}
        .bar-hover:hover{opacity:0.85!important}
        .row-hover:hover{background:${C.winePale}!important}
      `}</style>
      <div style={{minHeight:"100vh",background:`linear-gradient(170deg, ${C.wineBg} 0%, #F5F0EE 40%, ${C.wineBg} 100%)`,fontFamily:"'Outfit',sans-serif"}}>
        {/* Nav */}
        <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:50}}>
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <img src={LOGO_B64} alt="" style={{height:28,cursor:"pointer"}} onClick={()=>setPage("trips")} />
            <span style={{color:C.wine,fontWeight:600,fontSize:13,opacity:.3}}>|</span>
            <span style={{color:C.text,fontWeight:600,fontSize:13}}>📊 Тайлан & Аналитик</span>
          </div>
          <div style={{display:"flex",gap:8}}>
            <button onClick={()=>setPage("trips")} style={btnS}>← Аялалууд</button>
            <button onClick={loadAll} style={btnS}>↻ Шинэчлэх</button>
          </div>
        </div>

        <div style={{maxWidth:1200,margin:"0 auto",padding:"28px 20px 80px"}}>

          {/* Year selector & view tabs */}
          <div className="fu" style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:24,flexWrap:"wrap",gap:12}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:30,fontWeight:700,color:C.dark}}>Орлогын тайлан</h1>
              <div style={{display:"flex",gap:4}}>
                {(availableYears.length > 0 ? availableYears : [new Date().getFullYear()]).map(yr=>(
                  <button key={yr} onClick={()=>{setAnalyticsYear(yr);setAnalyticsMonth(null)}} style={{padding:"6px 16px",borderRadius:20,border:`1px solid ${analyticsYear===yr?C.wine+"66":C.border}`,background:analyticsYear===yr?C.wine:"#fff",color:analyticsYear===yr?"#fff":C.muted,fontWeight:700,fontSize:13,cursor:"pointer",fontFamily:"'Outfit'"}}>{yr}</button>
                ))}
              </div>
            </div>
            <div style={{display:"flex",gap:4}}>
              {[["monthly","Сараар"],["destination","Чиглэлээр"],["yearly","Жилээр"]].map(([k,label])=>(
                <button key={k} onClick={()=>{setAnalyticsView(k);setAnalyticsMonth(null)}} style={{padding:"7px 16px",borderRadius:8,border:`1px solid ${analyticsView===k?C.wine+"44":C.border}`,background:analyticsView===k?C.winePale:"#fff",color:analyticsView===k?C.wine:C.muted,fontWeight:600,fontSize:12,cursor:"pointer",fontFamily:"'Outfit'"}}>{label}</button>
              ))}
            </div>
          </div>

          {/* Year summary cards */}
          <div className="fu" style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:12,marginBottom:28,animationDelay:".04s"}}>
            {[
              { label:"Аялал", val:yearTrips.length, color:C.wine, bg:C.winePale },
              { label:"Нэхэмжлэл", val:yearInvoices.length, color:C.blue, bg:C.blueBg },
              { label:"Нийт орлого", val:fmt(yearTotal), color:C.dark, bg:C.cream },
              { label:"Төлөгдсөн", val:fmt(yearPaid), color:C.green, bg:C.greenBg },
              { label:"Үлдэгдэл", val:fmt(yearOutstanding), color:C.red, bg:C.redBg },
            ].map(s=>(
              <div key={s.label} style={{background:s.bg,borderRadius:14,padding:"18px 16px",border:`1px solid ${s.color}18`}}>
                <div style={{fontSize:8.5,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:s.color,marginBottom:6}}>{s.label}</div>
                <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:700,color:s.color}}>{s.val}</div>
              </div>
            ))}
          </div>

          {/* ── MONTHLY VIEW ── */}
          {analyticsView === "monthly" && (
            <div className="fu" style={{animationDelay:".08s"}}>
              {/* Bar chart */}
              <div style={{...cardS,padding:"24px 28px",marginBottom:20}}>
                <div style={{fontSize:10,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:16}}>{analyticsYear} оны сарын орлого</div>
                <div style={{display:"flex",alignItems:"flex-end",gap:6,height:180}}>
                  {monthlyData.map((m,i)=>{
                    const h = maxMonthly > 0 ? (m.total / maxMonthly) * 160 : 0;
                    const paidH = maxMonthly > 0 ? (m.paid / maxMonthly) * 160 : 0;
                    const isSelected = analyticsMonth === i;
                    return (
                      <div key={i} onClick={()=>setAnalyticsMonth(isSelected?null:i)} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",cursor:"pointer"}}>
                        <div style={{width:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"flex-end",height:165}}>
                          {m.total > 0 && <div style={{fontSize:9,fontWeight:600,color:C.muted,marginBottom:4}}>{(m.total/1e6).toFixed(1)}M</div>}
                          <div className="bar-hover" style={{width:"80%",height:Math.max(h,2),background:C.border,borderRadius:"4px 4px 0 0",position:"relative",overflow:"hidden",border:isSelected?`2px solid ${C.wine}`:"none",transition:"all .3s"}}>
                            <div style={{position:"absolute",bottom:0,width:"100%",height:paidH,background:`linear-gradient(180deg,${C.green}cc,${C.green})`,borderRadius:"0 0 0 0",transition:"height .5s"}}/>
                          </div>
                        </div>
                        <div style={{fontSize:10,fontWeight:isSelected?700:500,color:isSelected?C.wine:C.muted,marginTop:6}}>{i+1}сар</div>
                      </div>
                    );
                  })}
                </div>
                <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:14,fontSize:11}}>
                  <span style={{display:"flex",alignItems:"center",gap:4}}><span style={{width:10,height:10,borderRadius:2,background:C.green,display:"inline-block"}}/> Төлсөн</span>
                  <span style={{display:"flex",alignItems:"center",gap:4}}><span style={{width:10,height:10,borderRadius:2,background:C.border,display:"inline-block"}}/> Нийт</span>
                </div>
              </div>

              {/* Monthly table */}
              <div style={{...cardS,padding:0,overflow:"hidden"}}>
                <table style={{width:"100%",borderCollapse:"collapse"}}>
                  <thead><tr style={{background:C.winePale}}>
                    {["Сар","Аялал","Зорчигч","Нийт орлого","Төлөгдсөн","Үлдэгдэл","Хувь"].map((h,i)=>(
                      <th key={h} style={{padding:"12px 14px",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.wine,textAlign:i>1?"right":"left",borderBottom:`2px solid ${C.border}`}}>{h}</th>
                    ))}
                  </tr></thead>
                  <tbody>
                    {monthlyData.map((m,i)=>{
                      const p = pct(m.paid, m.total);
                      if (m.total === 0 && m.trips === 0) return null;
                      return (
                        <tr key={i} className="row-hover" onClick={()=>setAnalyticsMonth(analyticsMonth===i?null:i)} style={{cursor:"pointer",background:analyticsMonth===i?C.winePale+"88":"transparent",borderBottom:`1px solid ${C.border}33`,transition:"all .15s"}}>
                          <td style={{padding:"12px 14px",fontWeight:600,color:C.dark}}>{m.label}</td>
                          <td style={{padding:"12px 14px",color:C.muted}}>{m.trips}</td>
                          <td style={{padding:"12px 14px",textAlign:"right",color:C.muted}}>{m.invoices}</td>
                          <td style={{padding:"12px 14px",textAlign:"right",fontWeight:700,color:C.dark}}>{fmt(m.total)}</td>
                          <td style={{padding:"12px 14px",textAlign:"right",fontWeight:600,color:C.green}}>{fmt(m.paid)}</td>
                          <td style={{padding:"12px 14px",textAlign:"right",fontWeight:600,color:m.outstanding>0?C.red:C.green}}>{fmt(m.outstanding)}</td>
                          <td style={{padding:"12px 14px",textAlign:"right"}}>
                            <div style={{display:"flex",alignItems:"center",gap:6,justifyContent:"flex-end"}}>
                              <div style={{width:50,height:6,background:C.border,borderRadius:3,overflow:"hidden"}}><div style={{width:`${p}%`,height:"100%",background:p===100?C.green:p>0?C.orange:C.border,borderRadius:3}}/></div>
                              <span style={{fontSize:11,fontWeight:600,color:p===100?C.green:p>0?C.orange:C.muted}}>{p}%</span>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                    {/* Totals row */}
                    <tr style={{background:C.dark}}>
                      <td style={{padding:"14px 14px",fontWeight:700,color:"#fff"}}>Нийт {analyticsYear}</td>
                      <td style={{padding:"14px 14px",color:C.gold,fontWeight:600}}>{yearTrips.length}</td>
                      <td style={{padding:"14px 14px",textAlign:"right",color:C.gold,fontWeight:600}}>{yearInvoices.length}</td>
                      <td style={{padding:"14px 14px",textAlign:"right",fontWeight:700,color:C.gold,fontFamily:"'Cormorant Garamond',serif",fontSize:18}}>{fmt(yearTotal)}</td>
                      <td style={{padding:"14px 14px",textAlign:"right",fontWeight:600,color:C.greenBd}}>{fmt(yearPaid)}</td>
                      <td style={{padding:"14px 14px",textAlign:"right",fontWeight:600,color:yearOutstanding>0?"#FCA5A5":"#A7F3D0"}}>{fmt(yearOutstanding)}</td>
                      <td style={{padding:"14px 14px",textAlign:"right",fontWeight:700,color:C.gold}}>{pct(yearPaid,yearTotal)}%</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              {/* Month drill-down */}
              {analyticsMonth !== null && (
                <div className="fu" style={{marginTop:20}}>
                  <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark,marginBottom:14}}>{MONTHS[analyticsMonth]} — Аялалын жагсаалт</h3>
                  {monthDetailTrips.length === 0 && <div style={{padding:30,textAlign:"center",color:C.light}}>Аялал байхгүй</div>}
                  {monthDetailTrips.map(trip => {
                    const s = tripStats(trip.code);
                    const destInfo = DEST_CODES[trip.dest] || { color:C.wine, bg:C.winePale, name:trip.destName||trip.dest };
                    const p = pct(s.paid, s.total);
                    return (
                      <div key={trip.code} style={{...cardS,cursor:"pointer"}} onClick={()=>{setSelectedTrip(trip);setPage("trip-detail")}}>
                        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                          <div style={{display:"flex",alignItems:"center",gap:12}}>
                            <div style={{width:40,height:40,borderRadius:10,background:destInfo.bg,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:11,color:destInfo.color,fontFamily:"monospace"}}>{trip.dest}</div>
                            <div>
                              <div style={{fontFamily:"monospace",fontSize:15,fontWeight:700,color:C.dark}}>{trip.code}</div>
                              <div style={{fontSize:11,color:C.muted}}>{destInfo.name} · {trip.date} · {s.count} зорчигч</div>
                            </div>
                          </div>
                          <div style={{textAlign:"right"}}>
                            <div style={{fontWeight:700,color:C.dark}}>{fmt(s.total)}</div>
                            <div style={{display:"flex",alignItems:"center",gap:6,justifyContent:"flex-end",marginTop:4}}>
                              <div style={{width:60,height:5,background:C.border,borderRadius:3,overflow:"hidden"}}><div style={{width:`${p}%`,height:"100%",background:p===100?C.green:C.orange,borderRadius:3}}/></div>
                              <span style={{fontSize:10,color:C.muted}}>{p}%</span>
                              {s.outstanding>0 && <span style={{fontSize:10,color:C.red,fontWeight:600}}>-{fmt(s.outstanding)}</span>}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* ── DESTINATION VIEW ── */}
          {analyticsView === "destination" && (
            <div className="fu" style={{animationDelay:".08s"}}>
              {destData.length === 0 && <div style={{padding:60,textAlign:"center",color:C.light}}>Мэдээлэл олдсонгүй</div>}
              {destData.map(d => {
                const destInfo = DEST_CODES[d.dest] || { color:C.wine, bg:C.winePale };
                const p = pct(d.paid, d.total);
                return (
                  <div key={d.dest} style={{...cardS,padding:"24px 28px",marginBottom:16}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:16}}>
                      <div style={{display:"flex",alignItems:"center",gap:14}}>
                        <div style={{width:56,height:56,borderRadius:14,background:destInfo.bg,border:`2px solid ${destInfo.color}22`,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:18,color:destInfo.color,fontFamily:"monospace"}}>{d.dest}</div>
                        <div>
                          <div style={{fontSize:20,fontWeight:700,color:C.dark,fontFamily:"'Cormorant Garamond',serif"}}>{d.name}</div>
                          <div style={{fontSize:12,color:C.muted}}>{d.tripCount} аялал · {d.invoiceCount} зорчигч</div>
                        </div>
                      </div>
                      <div style={{textAlign:"right"}}>
                        <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:26,fontWeight:700,color:C.dark}}>{fmt(d.total)}</div>
                        <div style={{fontSize:11,color:C.muted}}>{analyticsYear} он</div>
                      </div>
                    </div>
                    {/* Progress */}
                    <div style={{marginBottom:14}}>
                      <div style={{display:"flex",justifyContent:"space-between",fontSize:11,marginBottom:4}}>
                        <span style={{color:C.green,fontWeight:600}}>Төлсөн: {fmt(d.paid)} ({p}%)</span>
                        <span style={{color:d.outstanding>0?C.red:C.green,fontWeight:600}}>Үлдэгдэл: {fmt(d.outstanding)}</span>
                      </div>
                      <div style={{width:"100%",height:8,background:C.border,borderRadius:4,overflow:"hidden"}}>
                        <div style={{width:`${p}%`,height:"100%",background:p===100?C.green:`linear-gradient(90deg,${C.green},${C.orange})`,borderRadius:4,transition:"width .5s"}}/>
                      </div>
                    </div>
                    {/* Monthly breakdown for this destination */}
                    <div style={{display:"grid",gridTemplateColumns:"repeat(12, 1fr)",gap:4}}>
                      {Array.from({length:12},(_,m)=>{
                        const mInvs = d.invoices.filter(inv=>{const trip=trips.find(t=>t.code===inv.tripCode);return trip&&new Date(trip.date).getMonth()===m});
                        const mTotal = mInvs.reduce((s,i)=>s+(i.total||0),0);
                        const mPaid = mInvs.reduce((s,i)=>s+getPaidAmount(i),0);
                        return (
                          <div key={m} style={{textAlign:"center"}}>
                            <div style={{fontSize:9,color:C.light,marginBottom:3}}>{m+1}с</div>
                            <div style={{height:40,background:C.border+"66",borderRadius:3,position:"relative",overflow:"hidden"}}>
                              {mTotal>0 && <div style={{position:"absolute",bottom:0,width:"100%",height:`${pct(mTotal,d.total/3)}%`,background:destInfo.color+"33",borderRadius:3}}/>}
                              {mPaid>0 && <div style={{position:"absolute",bottom:0,width:"100%",height:`${pct(mPaid,d.total/3)}%`,background:destInfo.color,borderRadius:3}}/>}
                            </div>
                            {mTotal>0 && <div style={{fontSize:8,color:C.muted,marginTop:2}}>{(mTotal/1e6).toFixed(1)}M</div>}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* ── YEARLY VIEW ── */}
          {analyticsView === "yearly" && (
            <div className="fu" style={{animationDelay:".08s"}}>
              <div style={{...cardS,padding:0,overflow:"hidden"}}>
                <table style={{width:"100%",borderCollapse:"collapse"}}>
                  <thead><tr style={{background:C.winePale}}>
                    {["Он","Аялал","Зорчигч","Нийт орлого","Төлөгдсөн","Үлдэгдэл","Төлбөрийн хувь"].map((h,i)=>(
                      <th key={h} style={{padding:"14px 16px",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.wine,textAlign:i>1?"right":"left",borderBottom:`2px solid ${C.border}`}}>{h}</th>
                    ))}
                  </tr></thead>
                  <tbody>
                    {yearlyData.map(y=>{
                      const p = pct(y.paid, y.total);
                      return (
                        <tr key={y.year} className="row-hover" style={{cursor:"pointer",borderBottom:`1px solid ${C.border}33`,background:y.year===analyticsYear?C.winePale+"66":"transparent"}} onClick={()=>{setAnalyticsYear(y.year);setAnalyticsView("monthly")}}>
                          <td style={{padding:"14px 16px",fontWeight:700,fontSize:16,color:C.dark,fontFamily:"'Cormorant Garamond',serif"}}>{y.year}</td>
                          <td style={{padding:"14px 16px",color:C.muted,fontWeight:600}}>{y.trips}</td>
                          <td style={{padding:"14px 16px",textAlign:"right",color:C.muted,fontWeight:600}}>{y.invoices}</td>
                          <td style={{padding:"14px 16px",textAlign:"right",fontWeight:700,fontSize:15,color:C.dark}}>{fmt(y.total)}</td>
                          <td style={{padding:"14px 16px",textAlign:"right",fontWeight:600,color:C.green}}>{fmt(y.paid)}</td>
                          <td style={{padding:"14px 16px",textAlign:"right",fontWeight:600,color:y.outstanding>0?C.red:C.green}}>{fmt(y.outstanding)}</td>
                          <td style={{padding:"14px 16px",textAlign:"right"}}>
                            <div style={{display:"flex",alignItems:"center",gap:8,justifyContent:"flex-end"}}>
                              <div style={{width:80,height:8,background:C.border,borderRadius:4,overflow:"hidden"}}><div style={{width:`${p}%`,height:"100%",background:p===100?C.green:p>0?C.orange:C.border,borderRadius:4}}/></div>
                              <span style={{fontSize:13,fontWeight:700,color:p===100?C.green:p>0?C.orange:C.muted}}>{p}%</span>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
              {yearlyData.length === 0 && <div style={{padding:60,textAlign:"center",color:C.light}}>Мэдээлэл олдсонгүй</div>}
            </div>
          )}

        </div>
      </div>
    </>
  );


  /* ═══════════════════════════════════════════
     TRIPS LIST (main page)
     ═══════════════════════════════════════════ */
  // ═══ LOGIN PAGE ═══
  if (!currentUser) return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}
        @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
        .fu{animation:fadeUp .35s ease both}
      `}</style>
      <div style={{minHeight:"100vh",background:`linear-gradient(170deg, ${C.wineBg} 0%, #F5F0EE 40%, ${C.wineBg} 100%)`,fontFamily:"'Outfit',sans-serif",display:"flex",alignItems:"center",justifyContent:"center"}}>
        <div className="fu" style={{background:"#fff",borderRadius:24,padding:"48px 44px",maxWidth:400,width:"100%",boxShadow:"0 20px 60px rgba(91,40,48,0.1)",border:`1px solid ${C.border}`}}>
          <div style={{textAlign:"center",marginBottom:32}}>
            <img src={LOGO_B64} alt="" style={{height:40,marginBottom:16}} />
            <h1 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:28,fontWeight:700,color:C.dark}}>New Juulchin Tours</h1>
            <p style={{fontSize:12,color:C.muted,marginTop:4}}>Менежерийн систем</p>
          </div>
          <div style={{marginBottom:16}}>
            <label style={{display:"block",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:6}}>Хэрэглэгч нэр</label>
            <input value={loginUser} onChange={e=>setLoginUser(e.target.value)} placeholder="username" onKeyDown={e=>e.key==="Enter"&&handleLogin()} style={{width:"100%",padding:"12px 16px",border:`1px solid ${C.border}`,borderRadius:10,fontSize:14,fontFamily:"'Outfit'",outline:"none",boxSizing:"border-box"}}/>
          </div>
          <div style={{marginBottom:20}}>
            <label style={{display:"block",fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:6}}>Нууц үг</label>
            <input type="password" value={loginPass} onChange={e=>setLoginPass(e.target.value)} placeholder="••••" onKeyDown={e=>e.key==="Enter"&&handleLogin()} style={{width:"100%",padding:"12px 16px",border:`1px solid ${C.border}`,borderRadius:10,fontSize:14,fontFamily:"'Outfit'",outline:"none",boxSizing:"border-box"}}/>
          </div>
          {loginError && <div style={{padding:"8px 14px",background:C.redBg,border:`1px solid ${C.redBd}`,borderRadius:8,fontSize:12,color:C.red,marginBottom:16}}>{loginError}</div>}
          <button onClick={handleLogin} style={{width:"100%",padding:"14px",background:C.wine,color:"#fff",border:"none",borderRadius:12,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:700,fontSize:14,letterSpacing:".02em"}}>Нэвтрэх</button>
        </div>
      </div>
    </>
  );

  if (page === "trips") return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
        *{box-sizing:border-box;margin:0;padding:0}
        input:focus,select:focus{border-color:${C.wine}!important;box-shadow:0 0 0 3px ${C.wine}18!important}
        @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
        .fu{animation:fadeUp .35s ease both}
        .tc:hover{border-color:${C.wine}44!important;box-shadow:0 2px 12px ${C.wine}10!important}
      `}</style>
      <div style={{minHeight:"100vh",background:`linear-gradient(170deg, ${C.wineBg} 0%, #F5F0EE 40%, ${C.wineBg} 100%)`,fontFamily:"'Outfit',sans-serif"}}>
        {/* Nav */}
        <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:50}}>
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <img src={LOGO_B64} alt="" style={{height:28}} />
            <span style={{color:C.wine,fontWeight:600,fontSize:13,opacity:.3}}>|</span>
            <span style={{color:C.text,fontWeight:600,fontSize:13}}>{currentUser.label}</span>
            <span style={{fontSize:9,padding:"2px 8px",borderRadius:10,background:isAdmin?C.wine:currentUser?.role==="manager"?"#7C3AED":isFinance?"#059669":C.blue,color:"#fff",fontWeight:700}}>{isAdmin?"ADMIN":currentUser?.role==="manager"?"MANAGER":isFinance?"FINANCE":"BOOKING"}</span>
          </div>
          <div style={{display:"flex",gap:8,alignItems:"center"}}>
            {isManager && <button onClick={()=>setPage("approvals")} style={{...btnS,position:"relative"}}>
              ⏳ Батлах
              {activeInvoices.filter(i=>i.pendingEdit).length > 0 && <span style={{position:"absolute",top:-4,right:-4,width:16,height:16,borderRadius:8,background:C.red,color:"#fff",fontSize:9,fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center"}}>{activeInvoices.filter(i=>i.pendingEdit).length}</span>}
            </button>}
            {isAdmin && <button onClick={()=>setPage("admin")} style={btnS}>👥 Хэрэглэгч</button>}
            {isManager && <button onClick={()=>setPage("settings")} style={btnS}>⚙ Чиглэл</button>}
            <button onClick={()=>setPage("analytics")} style={btnS}>📊 Тайлан</button>
            {(isAdmin || isFinance) && <button onClick={()=>setPage("finance")} style={{...btnS,color:"#059669",borderColor:"#059669"+"44"}}>💰 Санхүү</button>}
            {isAdmin && <button onClick={()=>setPage("recycle")} style={{...btnS,color:"#6B7280",borderColor:"#D1D5DB",position:"relative"}}>🗑 Хогийн сав{(deletedTrips.length+deletedInvoices.length)>0 && <span style={{position:"absolute",top:-4,right:-4,width:16,height:16,borderRadius:8,background:C.red,color:"#fff",fontSize:9,fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center"}}>{deletedTrips.length+deletedInvoices.length}</span>}</button>}
            <button onClick={loadAll} style={btnS}>↻ Шинэчлэх</button>
            {isManager && <button onClick={()=>setShowNewTrip(true)} style={btnP}>+ Шинэ аялал</button>}
            <button onClick={()=>setCurrentUser(null)} style={{...btnS,color:C.red,borderColor:C.red+"44"}}>Гарах</button>
          </div>
        </div>

        <div style={{maxWidth:1100,margin:"0 auto",padding:"28px 20px 80px"}}>

          {/* ═══ KPI Cards ═══ */}
          {(() => {
            const activeTrips = trips.filter(t=>t.status!=="cancelled");
            const totalInvoiced = invoices.reduce((s,i)=>s+(i.total||0),0);
            const totalPaid = invoices.reduce((s,inv)=>{
              if(inv.paymentStatus==="paid") return s+inv.total;
              if(inv.installEnabled&&inv.installments?.length) return s+inv.installments.filter(x=>x.paid).reduce((ss,x)=>ss+x.amount,0);
              return s;
            },0);
            const totalOutstanding = totalInvoiced - totalPaid;
            const totalPassengers = invoices.length;
            const totalInfants = invoices.reduce((s,inv)=>s+(inv.isInfant?1:(inv.items?.filter(x=>x.isInfant).length||0)),0);
            const kpis = [
              { label:"Аялал", value:activeTrips.length, sub:`${trips.filter(t=>t.status==="cancelled").length} цуцлагдсан`, icon:"✈️", color:C.blue, bg:C.blueBg },
              { label:"Зорчигч", value:totalPassengers, sub:totalInfants>0?`${totalInfants} нялх 👶`:"", icon:"👥", color:C.wine, bg:C.winePale },
              { label:"Нийт нэхэмжлэл", value:fmt(totalInvoiced), sub:`${invoices.length} ширхэг`, icon:"📋", color:C.dark, bg:C.cream },
              { label:"Төлсөн", value:fmt(totalPaid), sub:totalInvoiced>0?`${Math.round(totalPaid/totalInvoiced*100)}%`:"", icon:"✅", color:C.green, bg:C.greenBg },
              { label:"Үлдэгдэл", value:fmt(totalOutstanding), sub:activeInvoices.filter(i=>i.paymentStatus==="pending").length+" хүлээгдэж буй", icon:"⏳", color:totalOutstanding>0?C.red:C.green, bg:totalOutstanding>0?C.redBg:C.greenBg },
            ];
            return (
              <div style={{display:"grid",gridTemplateColumns:`repeat(${kpis.length}, 1fr)`,gap:10,marginBottom:20}}>
                {kpis.map((k,i) => (
                  <div key={i} className="fu" style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,padding:"14px 16px",animationDelay:`${i*0.05}s`}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                      <span style={{fontSize:8,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light}}>{k.label}</span>
                      <span style={{fontSize:16}}>{k.icon}</span>
                    </div>
                    <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:k.color}}>{k.value}</div>
                    {k.sub && <div style={{fontSize:10,color:C.muted,marginTop:2}}>{k.sub}</div>}
                  </div>
                ))}
              </div>
            );
          })()}

          {/* ═══ Booking Manager Stats ═══ */}
          {isManager && (() => {
            const byUser = {};
            invoices.forEach(inv => {
              const u = inv.createdByLabel || inv.createdBy;
              if (!u) return; // Skip invoices without createdBy
              if (!byUser[u]) byUser[u] = { count: 0, total: 0, paid: 0, thisMonth: 0 };
              byUser[u].count++;
              byUser[u].total += inv.total || 0;
              if (inv.paymentStatus === "paid") byUser[u].paid++;
              const now = new Date();
              const invDate = new Date(inv.savedAt || inv.invDate);
              if (invDate.getMonth() === now.getMonth() && invDate.getFullYear() === now.getFullYear()) byUser[u].thisMonth++;
            });
            const entries = Object.entries(byUser).sort((a,b) => b[1].count - a[1].count);
            if (entries.length === 0) return null;
            return (
              <div className="fu" style={{background:"#fff",borderRadius:12,border:`1px solid ${C.border}`,padding:"16px 20px",marginBottom:20,animationDelay:".15s"}}>
                <div style={{fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light,marginBottom:10}}>👤 BOOKING MANAGER БҮРТГЭЛ</div>
                <div style={{display:"grid",gridTemplateColumns:`repeat(${Math.min(entries.length,5)}, 1fr)`,gap:10}}>
                  {entries.map(([name, d], i) => {
                    const colors = [C.wine, C.blue, C.orange, C.green, "#7C3AED"];
                    const cl = colors[i % colors.length];
                    return (
                      <div key={name} style={{padding:"12px 14px",background:`${cl}08`,borderRadius:10,border:`1px solid ${cl}22`}}>
                        <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8}}>
                          <div style={{width:28,height:28,borderRadius:14,background:cl,color:"#fff",display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:700}}>{name.charAt(0).toUpperCase()}</div>
                          <div style={{fontWeight:700,fontSize:13,color:C.dark}}>{name}</div>
                        </div>
                        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:4,fontSize:10}}>
                          <div><span style={{color:C.light}}>Нийт:</span> <b style={{color:cl}}>{d.count}</b></div>
                          <div><span style={{color:C.light}}>Энэ сар:</span> <b style={{color:cl}}>{d.thisMonth}</b></div>
                          <div><span style={{color:C.light}}>Дүн:</span> <b>{fmt(d.total)}</b></div>
                          <div><span style={{color:C.light}}>Төлсөн:</span> <b style={{color:C.green}}>{d.paid}</b></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })()}

          {/* Pending approvals for manager */}
          {isManager && activeInvoices.filter(i=>i.pendingEdit).length > 0 && (
            <div onClick={()=>setPage("approvals")} style={{marginBottom:16,padding:"14px 20px",background:"#FEF3C7",border:"1px solid #F59E0B44",borderRadius:14,cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{display:"flex",alignItems:"center",gap:10}}>
                <span style={{fontSize:20}}>⏳</span>
                <div>
                  <div style={{fontWeight:700,fontSize:13,color:"#92400E"}}>{activeInvoices.filter(i=>i.pendingEdit).length} засвар хүлээгдэж байна</div>
                  <div style={{fontSize:11,color:"#D97706"}}>Дарж батлах эсвэл татгалзах</div>
                </div>
              </div>
              <span style={{fontSize:20}}>→</span>
            </div>
          )}

          {/* Due date notifications */}
          {notifications.length > 0 && (
            <div style={{marginBottom:20,borderRadius:14,border:`1px solid ${C.orangeBd}`,overflow:"hidden"}}>
              <div style={{background:C.orangeBg,padding:"10px 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <span style={{fontSize:11,fontWeight:700,color:C.orange}}>⏰ Төлбөрийн мэдэгдэл ({notifications.length})</span>
              </div>
              {notifications.slice(0,4).map((n,i) => (
                <div key={i} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 20px",borderTop:`1px solid ${C.border}33`,background:i%2===0?"#fff":"#FAFAFA",cursor:"pointer"}} onClick={()=>{const trip=trips.find(t=>t.code===n.inv.tripCode);if(trip){setSelectedTrip(trip);setPage("trip-detail")}}}>
                  <div style={{display:"flex",alignItems:"center",gap:10}}>
                    <span style={{fontSize:10,fontWeight:700,padding:"2px 8px",borderRadius:12,background:n.bg,color:n.color,border:`1px solid ${n.bd}`}}>{n.type==="overdue"?"🔴":n.type==="today"?"🟠":"🟡"} {n.label}</span>
                    <span style={{fontSize:12,fontWeight:600,color:C.dark}}>{n.inv.clientName}</span>
                    <span style={{fontSize:11,color:C.muted}}>{n.inv.tripCode}</span>
                    {n.instLabel && <span style={{fontSize:10,color:C.muted}}>· {n.instLabel}</span>}
                  </div>
                  <span style={{fontWeight:700,fontSize:12,color:n.color}}>{fmt(n.amount)}</span>
                </div>
              ))}
              {notifications.length > 4 && <div style={{padding:"6px 20px",fontSize:10,color:C.muted,background:"#FAFAFA",textAlign:"center"}}>+{notifications.length-4} бусад...</div>}
            </div>
          )}

          {/* ═══ Financial Query (compact) ═══ */}
          {trips.length > 0 && (
            <div style={{marginBottom:20,background:C.cream,borderRadius:14,border:`1px solid ${C.border}`,padding:"14px 20px"}}>
              <div style={{display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
                <span style={{fontSize:10,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.wine}}>📊 Санхүү</span>
                <input type="date" value={finFrom} onChange={e=>setFinFrom(e.target.value)} style={{...inp,width:140,padding:"6px 10px",fontSize:11}}/>
                <span style={{color:C.light,fontSize:11}}>—</span>
                <input type="date" value={finTo} onChange={e=>setFinTo(e.target.value)} style={{...inp,width:140,padding:"6px 10px",fontSize:11}}/>
                <select value={finDest} onChange={e=>setFinDest(e.target.value)} style={{...inp,width:140,padding:"6px 10px",fontSize:11,cursor:"pointer"}}>
                  <option value="all">Бүх чиглэл</option>
                  {Object.entries(DEST_CODES).map(([c,info])=><option key={c} value={c}>{info.name} ({c})</option>)}
                </select>
                <button onClick={runFinQuery} style={{padding:"6px 16px",background:C.wine,color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:600,fontSize:11}}>Хайх</button>
                {finResult && <button onClick={exportCSV} style={{padding:"6px 16px",background:C.green,color:"#fff",border:"none",borderRadius:8,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:600,fontSize:11}}>📥 Excel</button>}
              </div>
              {finResult && (
                <div style={{display:"flex",gap:20,marginTop:12,padding:"10px 0 0",borderTop:`1px solid ${C.border}55`,flexWrap:"wrap",alignItems:"center"}}>
                  {[
                    { label:"Аялал", val:finResult.trips, color:C.wine },
                    { label:"Зорчигч", val:finResult.invoices, color:C.blue },
                    { label:"Нэхэмжилсэн", val:fmt(finResult.total), color:C.dark },
                    { label:"Төлсөн", val:fmt(finResult.paid), color:C.green },
                    { label:"Үлдэгдэл", val:fmt(finResult.outstanding), color:finResult.outstanding>0?C.red:C.green },
                  ].map(s=>(
                    <div key={s.label} style={{minWidth:100}}>
                      <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light}}>{s.label}</div>
                      <div style={{fontSize:18,fontWeight:700,color:s.color,fontFamily:"'Cormorant Garamond',serif"}}>{s.val}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* ═══ Destination Thumbnails ═══ */}
          <div style={{marginBottom:28}}>
            {/* New trip modal */}
            {showNewTrip && (
              <div className="fu" style={{...cardS,background:`linear-gradient(135deg, ${C.winePale}, ${C.goldLight})`,border:`2px solid ${C.gold}44`,marginBottom:20,padding:"28px 32px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
                  <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:C.dark}}>Шинэ аялал бүртгэх</h2>
                  <button onClick={()=>setShowNewTrip(false)} style={{background:"none",border:"none",fontSize:20,color:C.light,cursor:"pointer"}}>✕</button>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 80px 2fr",gap:12,alignItems:"end"}}>
                  <div>
                    <label style={lbl}>Чиглэлийн код</label>
                    <select value={customDest?"OTHER":(newDest)} onChange={e=>{const v=e.target.value;if(v==="OTHER"){setCustomDest("");setNewDest("")}else{setCustomDest("");setNewDest(v)}}} style={{...inp,cursor:"pointer"}}>
                      {Object.entries(destCodes).map(([c,info])=><option key={c} value={c}>{c} — {info.name}</option>)}
                      <option value="OTHER">+ Шинэ код...</option>
                    </select>
                  </div>
                  <div><label style={lbl}>Нисэх огноо</label><input type="date" value={newDate} onChange={e=>setNewDate(e.target.value)} style={inp}/></div>
                  <div><label style={lbl}>Дугаар</label><input type="number" min={1} max={99} value={newSeq} onChange={e=>setNewSeq(Math.max(1,+e.target.value))} style={{...inp,textAlign:"center"}}/></div>
                  <div>
                    <label style={lbl}>Аялалын код (автомат)</label>
                    <div style={{display:"flex",gap:10,alignItems:"center"}}>
                      <div style={{...inp,background:C.winePale,fontWeight:700,fontFamily:"monospace",fontSize:16,letterSpacing:".06em",border:`1px solid ${C.border}`,flex:1}}>{genTripCode(customDest||newDest||"???",newDate,newSeq)}</div>
                      <button onClick={createTrip} style={{...btnP,padding:"10px 24px",whiteSpace:"nowrap"}}>Бүртгэх</button>
                    </div>
                  </div>
                </div>
                {customDest !== "" || (newDest === "" || newDest === "OTHER") ? (
                  <div style={{display:"grid",gridTemplateColumns:"120px 1fr 1fr",gap:12,marginTop:12}}>
                    <div><label style={lbl}>Шинэ код *</label><input maxLength={5} value={customDest} onChange={e=>setCustomDest(e.target.value.toUpperCase().replace(/[^A-Z]/g,""))} placeholder="BKK" style={{...inp,textTransform:"uppercase",fontWeight:700,fontFamily:"monospace",textAlign:"center"}}/></div>
                    <div><label style={lbl}>Чиглэлийн нэр *</label><input value={customDestName} onChange={e=>setCustomDestName(e.target.value)} placeholder="Бангкок" style={inp}/></div>
                    <div><label style={lbl}>Банк</label><select value={newDest||"Хаан банк"} onChange={e=>setNewDest(e.target.value)} style={{...inp,cursor:"pointer"}}>{Object.keys(ALL_BANKS).map(b=><option key={b} value={b}>{b}</option>)}</select></div>
                  </div>
                ) : null}
              </div>
            )}

            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
              <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:C.dark}}>Чиглэлүүд</h2>
              <div style={{display:"flex",gap:8}}>
                <div style={{position:"relative",maxWidth:240}}>
                  <input placeholder="🔍 Хайх..." value={searchQ} onChange={e=>setSearchQ(e.target.value)} style={{...inp,fontSize:11,padding:"7px 14px",borderRadius:20}} />
                </div>
              </div>
            </div>

            {(() => {
              const DEST_EMOJI = { SYX:"🏝️", PQC:"🌴", JAP:"🗼", BKK:"🛕", JEJ:"🌊", NRT:"⛩️", ICN:"🎎", SGN:"🍜", DPS:"🌺" };
              const getEmoji = (code) => DEST_EMOJI[code] || "✈️";
              // Get all destinations that have trips
              const destWithTrips = {};
              trips.forEach(trip => {
                const dk = trip.dest || "OTHER";
                if (!destWithTrips[dk]) destWithTrips[dk] = [];
                destWithTrips[dk].push(trip);
              });

              return (
                <div style={{display:"grid",gridTemplateColumns:`repeat(${Math.min(Math.max(Object.keys(destWithTrips).length,1), 3)}, 1fr)`,gap:14}}>
                  {Object.entries(destWithTrips).map(([destCode, destTrips]) => {
                    const destInfo = DEST_CODES[destCode] || { color: C.wine, bg: C.winePale, name: destCode };
                    const dTotal = destTrips.reduce((s,t) => { const st = tripStats(t.code); return s + st.total; }, 0);
                    const dPaid = destTrips.reduce((s,t) => { const st = tripStats(t.code); return s + st.paid; }, 0);
                    const dInvCount = destTrips.reduce((s,t) => s + tripInvoices(t.code).length, 0);
                    const dSeatCount = destTrips.reduce((s,t) => { const st = tripStats(t.code); return s + st.seatCount; }, 0);
                    const dInfantCount = destTrips.reduce((s,t) => { const st = tripStats(t.code); return s + st.infantCount; }, 0);
                    const dPct = pct(dPaid, dTotal);
                    const nextTrip = destTrips.filter(t => t.status !== "cancelled").sort((a,b)=>(a.date||"").localeCompare(b.date||"")).find(t => new Date(t.date) >= new Date());
                    return (
                      <div key={destCode} className="fu tc" onClick={()=>{setSelectedDest(destCode);setPage("dest-trips")}} style={{
                        borderRadius:18, overflow:"hidden", cursor:"pointer",
                        border:`1px solid ${C.border}`, background:"#fff", transition:"all .25s",
                        boxShadow:"0 2px 12px rgba(0,0,0,0.04)",
                      }}>
                        <div style={{background:`linear-gradient(135deg, ${destInfo.color}15, ${destInfo.bg})`,padding:"20px 22px 16px",position:"relative",overflow:"hidden"}}>
                          <div style={{position:"absolute",top:-10,right:-10,fontSize:64,opacity:0.12,transform:"rotate(-15deg)"}}>{getEmoji(destCode)}</div>
                          <div style={{display:"flex",alignItems:"center",gap:12,position:"relative"}}>
                            <div style={{width:52,height:52,borderRadius:14,background:"#fff",boxShadow:`0 4px 16px ${destInfo.color}22`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:26}}>{getEmoji(destCode)}</div>
                            <div>
                              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:700,color:C.dark,lineHeight:1.1}}>{destInfo.name}</div>
                              <div style={{fontSize:12,fontWeight:700,color:destInfo.color,fontFamily:"monospace",marginTop:2}}>{destCode}</div>
                            </div>
                          </div>
                        </div>
                        <div style={{padding:"14px 22px 18px"}}>
                          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
                            <div><div style={{fontSize:8,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light}}>Аялал</div><div style={{fontSize:20,fontWeight:700,color:C.dark,fontFamily:"'Cormorant Garamond',serif"}}>{destTrips.length}</div></div>
                            <div><div style={{fontSize:8,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.light}}>Суудал / Нялх</div><div style={{fontSize:20,fontWeight:700,color:C.dark,fontFamily:"'Cormorant Garamond',serif"}}>{dSeatCount}{dInfantCount > 0 ? <span style={{fontSize:13,color:C.orange}}> +{dInfantCount}👶</span> : ""}</div></div>
                          </div>
                          <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:C.dark}}>{fmt(dTotal)}</div>
                          <div style={{marginTop:8}}>
                            <div style={{display:"flex",justifyContent:"space-between",fontSize:10,marginBottom:3}}>
                              <span style={{color:C.green,fontWeight:600}}>Төлсөн {dPct}%</span>
                              {dTotal-dPaid > 0 && <span style={{color:C.red,fontWeight:600}}>{fmt(dTotal-dPaid)}</span>}
                            </div>
                            <div style={{width:"100%",height:6,background:C.border,borderRadius:3,overflow:"hidden"}}>
                              <div style={{width:`${dPct}%`,height:"100%",background:dPct===100?C.green:dPct>0?`linear-gradient(90deg,${C.green},${destInfo.color})`:C.border,borderRadius:3,transition:"width .5s"}}/>
                            </div>
                          </div>
                          {nextTrip && <div style={{marginTop:8,fontSize:10.5,color:C.muted}}>Дараагийн: <b style={{color:destInfo.color}}>{nextTrip.date}</b></div>}
                        </div>
                      </div>
                    );
                  })}
                  {Object.keys(destWithTrips).length === 0 && !loading && (
                    <div style={{gridColumn:"1/-1",textAlign:"center",padding:40,color:C.light}}>
                      <div style={{fontSize:48,marginBottom:12}}>✈️</div>
                      <div style={{fontSize:14}}>Аялал бүртгээгүй байна</div>
                      {isManager && <button onClick={()=>setShowNewTrip(true)} style={{...btnP,marginTop:16}}>+ Шинэ аялал нэмэх</button>}
                    </div>
                  )}
                </div>
              );
            })()}
          </div>

          {/* Loading */}
          {loading && <div style={{textAlign:"center",padding:40,color:C.muted}}>Уншиж байна...</div>}
        </div>
        {saveMsg && <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"12px 28px",background:saveMsg.includes("✓")?C.green:C.red,color:"#fff",borderRadius:50,fontFamily:"'Outfit'",fontWeight:600,fontSize:13,boxShadow:"0 4px 24px rgba(0,0,0,.2)",zIndex:100}}>{saveMsg}</div>}
      </div>
    </>
  );


  /* ═══════════════════════════════════════════
     DEST-TRIPS (trips for a destination)
     ═══════════════════════════════════════════ */
  if (page === "dest-trips" && selectedDest) {
    const destInfo = DEST_CODES[selectedDest] || { color: C.wine, bg: C.winePale, name: selectedDest };
    const destTrips = trips.filter(t => t.dest === selectedDest).sort((a,b) => (b.date||"").localeCompare(a.date||""));
    const DEST_EMOJI = { SYX:"🏝️", PQC:"🌴", JAP:"🗼", BKK:"🛕", JEJ:"🌊" };
    const emoji = DEST_EMOJI[selectedDest] || "✈️";
    // Group by date
    const dateGroups = {};
    destTrips.forEach(trip => { const dk = trip.date || "Огноогүй"; if (!dateGroups[dk]) dateGroups[dk] = []; dateGroups[dk].push(trip); });
    const sortedDates = Object.keys(dateGroups).sort((a,b) => b.localeCompare(a));
    const dTotal = destTrips.reduce((s,t) => { const st = tripStats(t.code); return s + st.total; }, 0);
    const dPaid = destTrips.reduce((s,t) => { const st = tripStats(t.code); return s + st.paid; }, 0);
    const dInvCount = destTrips.reduce((s,t) => s + tripInvoices(t.code).length, 0);
    const dPct = pct(dPaid, dTotal);
    return (
      <>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
          *{box-sizing:border-box;margin:0;padding:0}
          @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
          .fu{animation:fadeUp .35s ease both} .tc:hover{box-shadow:0 6px 24px rgba(91,40,48,0.08)!important;transform:translateY(-2px)}
        `}</style>
        <div style={{minHeight:"100vh",background:`linear-gradient(170deg, ${destInfo.bg} 0%, #F5F0EE 40%, ${C.wineBg} 100%)`,fontFamily:"'Outfit',sans-serif"}}>
          <div style={{background:destInfo.bg,borderBottom:`2px solid ${destInfo.color}22`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:50}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <button onClick={()=>setPage("trips")} style={{background:"none",border:"none",fontSize:14,color:C.muted,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:500}}>← Хянах самбар</button>
              <span style={{color:destInfo.color,fontWeight:600,fontSize:13,opacity:.3}}>|</span>
              <span style={{fontSize:18}}>{emoji}</span>
              <span style={{fontWeight:700,fontSize:15,color:C.dark}}>{destInfo.name}</span>
              <span style={{fontFamily:"monospace",fontSize:12,color:destInfo.color,fontWeight:700}}>{selectedDest}</span>
            </div>
            {isManager && <button onClick={()=>{setNewDest(selectedDest);setShowNewTrip(true)}} style={btnP}>+ Шинэ аялал</button>}
          </div>

          <div style={{maxWidth:1000,margin:"0 auto",padding:"28px 20px 80px"}}>
            {/* New trip modal */}
            {showNewTrip && (
              <div className="fu" style={{...cardS,background:`linear-gradient(135deg, ${C.winePale}, ${C.goldLight})`,border:`2px solid ${C.gold}44`,marginBottom:20,padding:"28px 32px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
                  <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:C.dark}}>Шинэ аялал бүртгэх</h2>
                  <button onClick={()=>setShowNewTrip(false)} style={{background:"none",border:"none",fontSize:20,color:C.light,cursor:"pointer"}}>✕</button>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 80px 2fr",gap:12,alignItems:"end"}}>
                  <div>
                    <label style={lbl}>Чиглэлийн код</label>
                    <select value={customDest?"OTHER":(newDest||selectedDest)} onChange={e=>{const v=e.target.value;if(v==="OTHER"){setCustomDest("");setNewDest("")}else{setCustomDest("");setNewDest(v)}}} style={{...inp,cursor:"pointer"}}>
                      {Object.entries(destCodes).map(([c,info])=><option key={c} value={c}>{c} — {info.name}</option>)}
                      <option value="OTHER">+ Шинэ код...</option>
                    </select>
                  </div>
                  <div><label style={lbl}>Нисэх огноо</label><input type="date" value={newDate} onChange={e=>setNewDate(e.target.value)} style={inp}/></div>
                  <div><label style={lbl}>Дугаар</label><input type="number" min={1} max={99} value={newSeq} onChange={e=>setNewSeq(Math.max(1,+e.target.value))} style={{...inp,textAlign:"center"}}/></div>
                  <div>
                    <label style={lbl}>Аялалын код (автомат)</label>
                    <div style={{display:"flex",gap:10,alignItems:"center"}}>
                      <div style={{...inp,background:C.winePale,fontWeight:700,fontFamily:"monospace",fontSize:16,letterSpacing:".06em",border:`1px solid ${C.border}`,flex:1}}>{genTripCode(customDest||newDest||selectedDest||"???",newDate,newSeq)}</div>
                      <button onClick={createTrip} style={{...btnP,padding:"10px 24px",whiteSpace:"nowrap"}}>Бүртгэх</button>
                    </div>
                  </div>
                </div>
                {customDest !== "" || (newDest === "" || newDest === "OTHER") ? (
                  <div style={{display:"grid",gridTemplateColumns:"120px 1fr 1fr",gap:12,marginTop:12}}>
                    <div><label style={lbl}>Шинэ код *</label><input maxLength={5} value={customDest} onChange={e=>setCustomDest(e.target.value.toUpperCase().replace(/[^A-Z]/g,""))} placeholder="BKK" style={{...inp,textTransform:"uppercase",fontWeight:700,fontFamily:"monospace",textAlign:"center"}}/></div>
                    <div><label style={lbl}>Чиглэлийн нэр *</label><input value={customDestName} onChange={e=>setCustomDestName(e.target.value)} placeholder="Бангкок" style={inp}/></div>
                    <div><label style={lbl}>Банк</label><select value={newDest||"Хаан банк"} onChange={e=>setNewDest(e.target.value)} style={{...inp,cursor:"pointer"}}>{Object.keys(ALL_BANKS).map(b=><option key={b} value={b}>{b}</option>)}</select></div>
                  </div>
                ) : null}
              </div>
            )}
            {/* Dest summary */}
            <div className="fu" style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:24}}>
              {[
                { label:"Аялал", val:destTrips.length, color:destInfo.color, bg:destInfo.bg },
                { label:"Зорчигч", val:dInvCount, color:C.blue, bg:C.blueBg },
                { label:"Нийт дүн", val:fmt(dTotal), color:C.dark, bg:C.cream },
                { label:"Үлдэгдэл", val:fmt(dTotal-dPaid), color:C.red, bg:C.redBg },
              ].map(s=>(
                <div key={s.label} style={{background:s.bg,borderRadius:14,padding:"16px 18px",border:`1px solid ${s.color}18`}}>
                  <div style={{fontSize:8.5,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:s.color,marginBottom:4}}>{s.label}</div>
                  <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:700,color:s.color}}>{s.val}</div>
                </div>
              ))}
            </div>

            {/* Date grouped trips */}
            {sortedDates.map(dateKey => {
              const dateTrips = dateGroups[dateKey];
              const dtTotal = dateTrips.reduce((s,t) => { const st = tripStats(t.code); return s + st.total; }, 0);
              const dtInv = dateTrips.reduce((s,t) => s + tripInvoices(t.code).length, 0);
              return (
                <div key={dateKey} style={{marginBottom:16}}>
                  <div style={{display:"flex",alignItems:"center",gap:10,padding:"8px 0 6px",borderBottom:`2px solid ${destInfo.color}22`,marginBottom:8}}>
                    <span style={{fontSize:14,fontWeight:700,color:destInfo.color}}>✈ {dateKey}</span>
                    <span style={{fontSize:11,color:C.muted}}>{dateTrips.length} аялал · {dtInv} зорчигч · {fmt(dtTotal)}</span>
                  </div>
                  {dateTrips.map((trip,i) => {
                    const s = tripStats(trip.code);
                    const pctPaid = pct(s.paid, s.total);
                    const isCancelled = trip.status === "cancelled";
                    return (
                      <div key={trip.code} className="fu tc" style={{background:C.cream,borderRadius:14,border:`1px solid ${C.border}`,padding:"16px 20px",marginBottom:8,cursor:"pointer",opacity:isCancelled?0.55:1,animationDelay:`${i*0.03}s`,transition:"all .2s"}} onClick={()=>{setSelectedTrip(trip);setPage("trip-detail")}}>
                        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                          <div>
                            <div style={{display:"flex",alignItems:"center",gap:8}}>
                              <span style={{fontFamily:"monospace",fontSize:15,fontWeight:700,color:isCancelled?"#9CA3AF":C.dark,textDecoration:isCancelled?"line-through":"none"}}>{trip.code}</span>
                              {isCancelled && <span style={badge("cancelled")}>✕ Цуцлагдсан</span>}
                              {!isCancelled && s.allPaid && s.count>0 && <span style={badge("paid")}>✓ Бүгд төлсөн</span>}
                              {!isCancelled && !s.allPaid && s.pendingCount>0 && <span style={badge("pending")}>{s.pendingCount} хүлээгдэж буй</span>}
                            </div>
                            <div style={{fontSize:11,color:C.muted,marginTop:2}}>🪑 {s.seatCount} суудал{s.infantCount > 0 ? ` + ${s.infantCount} 👶` : ""}</div>
                          </div>
                          <div style={{textAlign:"right"}}>
                            <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:19,fontWeight:700,color:C.dark}}>{fmt(s.total)}</div>
                            {s.outstanding > 0 && <div style={{fontSize:10,color:C.red,fontWeight:600}}>{fmt(s.outstanding)}</div>}
                            {s.count > 0 && (
                              <div style={{width:80,height:5,background:C.border,borderRadius:3,marginTop:4,marginLeft:"auto",overflow:"hidden"}}>
                                <div style={{width:`${pctPaid}%`,height:"100%",background:pctPaid===100?C.green:pctPaid>0?C.orange:C.border,borderRadius:3}}/>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            })}
            {destTrips.length === 0 && (
              <div style={{textAlign:"center",padding:60,color:C.light}}>
                <div style={{fontSize:48,marginBottom:12}}>{emoji}</div>
                <div style={{fontSize:14}}>Аялал бүртгэгдээгүй</div>
              </div>
            )}
          </div>
          {saveMsg && <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"12px 28px",background:saveMsg.includes("✓")?C.green:C.red,color:"#fff",borderRadius:50,fontFamily:"'Outfit'",fontWeight:600,fontSize:13,boxShadow:"0 4px 24px rgba(0,0,0,.2)",zIndex:100}}>{saveMsg}</div>}
        </div>
      </>
    );
  }


  /* ═══════════════════════════════════════════
     TRIP DETAIL (invoices for a trip)
     ═══════════════════════════════════════════ */
  if (page === "trip-detail" && selectedTrip) {
    const trip = selectedTrip;
    const invs = tripInvoices(trip.code);
    const s = tripStats(trip.code);
    const destInfo = DEST_CODES[trip.dest] || { color: C.wine, bg: C.winePale, name: trip.destName || trip.dest };
    const pctPaid = pct(s.paid, s.total);
    return (
      <>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
          *{box-sizing:border-box;margin:0;padding:0}
          input:focus,select:focus,textarea:focus{border-color:${C.wine}!important;box-shadow:0 0 0 3px ${C.wine}18!important}
          @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
          .fu{animation:fadeUp .35s ease both}
        `}</style>
        <div style={{minHeight:"100vh",background:`linear-gradient(170deg, ${C.wineBg} 0%, #F5F0EE 40%, ${C.wineBg} 100%)`,fontFamily:"'Outfit',sans-serif"}}>
          <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:50}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <button onClick={()=>setPage("trips")} style={{background:"none",border:"none",fontSize:14,color:C.muted,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:500}}>← Аялалууд</button>
              <span style={{color:C.wine,fontWeight:600,fontSize:13,opacity:.3}}>|</span>
              <span style={{fontFamily:"monospace",fontWeight:700,fontSize:15,color:C.dark}}>{trip.code}</span>
              <span style={{background:destInfo.bg,color:destInfo.color,fontSize:10.5,fontWeight:700,padding:"3px 10px",borderRadius:20}}>{destInfo.name}</span>
            </div>
            <div style={{display:"flex",gap:8}}>
              <button onClick={loadAll} style={btnS}>↻ Шинэчлэх</button>
              {trip.status !== "cancelled" && isManager && <button onClick={()=>setShowCancelModal(true)} style={{...btnS,color:"#991B1B",borderColor:"#FECACA"}}>✕ Цуцлах</button>}
              {isManager && <button onClick={()=>deleteTrip(trip)} style={{...btnS,color:"#fff",background:"#DC2626",borderColor:"#DC2626"}}>🗑 Устгах</button>}
              {trip.status !== "cancelled" && <button onClick={()=>{setEditingInvoice(null);setInvClient("");setInvPhone("");setInvInfant(false);setInvType("package");setInvNotes("");const tm=new Date();tm.setDate(tm.getDate()+1);setInvDueDate(tm.toISOString().split("T")[0]);setInvInstall(false);setInvItems([{id:1,description:`${destInfo.name} аялал`,qty:1,rate:0}]);setPage("new-invoice")}} style={btnP}>+ Нэхэмжлэл нэмэх</button>}
            </div>
          </div>

          <div style={{maxWidth:1000,margin:"0 auto",padding:"28px 20px 80px"}}>
            {/* Cancelled banner */}
            {trip.status === "cancelled" && (
              <div className="fu" style={{background:"#F3F4F6",borderRadius:14,padding:"20px 28px",border:"2px solid #D1D5DB",marginBottom:20,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div>
                  <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
                    <span style={{fontSize:20}}>🚫</span>
                    <span style={{fontWeight:700,fontSize:16,color:"#374151"}}>Энэ аялал цуцлагдсан</span>
                  </div>
                  <div style={{fontSize:12,color:"#6B7280"}}>Шалтгаан: <b>{trip.cancelReason}</b></div>
                  {trip.cancelledAt && <div style={{fontSize:11,color:"#9CA3AF",marginTop:4}}>Цуцалсан: {new Date(trip.cancelledAt).toLocaleString("mn-MN")}</div>}
                </div>
                <span style={badge("cancelled")}>✕ Цуцлагдсан</span>
              </div>
            )}

            {/* Trip header */}
            <div className="fu" style={{background:`linear-gradient(135deg, ${destInfo.bg} 0%, ${C.cream} 100%)`,borderRadius:16,padding:"28px 32px",border:`1px solid ${destInfo.color}22`,marginBottom:24}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div>
                  <div style={{fontFamily:"monospace",fontSize:28,fontWeight:800,color:C.dark,letterSpacing:".04em"}}>{trip.code}</div>
                  <div style={{fontSize:13,color:C.muted,marginTop:4}}>{destInfo.name} · Нисэх огноо: {trip.date}</div>
                </div>
                <div style={{textAlign:"right"}}>
                  <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:32,fontWeight:700,color:C.dark}}>{fmt(s.total)}</div>
                  <div style={{fontSize:12,color:C.muted}}>🪑 {s.seatCount} суудал{s.infantCount > 0 ? ` + ${s.infantCount} 👶` : ""}</div>
                  <div style={{display:"flex",gap:10,marginTop:4,fontSize:10,color:C.muted}}>
                    {s.packageCount > 0 && <span>📦 Багц: {s.packageCount}</span>}
                    {s.flightCount > 0 && <span>🛫 Нислэг: {s.flightCount}</span>}
                    {s.groundCount > 0 && <span>🏨 Газар: {s.groundCount}</span>}
                  </div>
                </div>
              </div>
              {s.count > 0 && (
                <div style={{marginTop:20}}>
                  <div style={{display:"flex",justifyContent:"space-between",fontSize:11,marginBottom:6}}>
                    <span style={{color:C.green,fontWeight:600}}>Төлсөн: {fmt(s.paid)} ({pctPaid}%)</span>
                    <span style={{color:C.red,fontWeight:600}}>Үлдэгдэл: {fmt(s.outstanding)}</span>
                  </div>
                  <div style={{width:"100%",height:10,background:C.border,borderRadius:5,overflow:"hidden"}}>
                    <div style={{width:`${pctPaid}%`,height:"100%",background:pctPaid===100?C.green:pctPaid>0?`linear-gradient(90deg,${C.green},${C.orange})`:C.border,borderRadius:5,transition:"width .5s"}}/>
                  </div>
                  <div style={{display:"flex",gap:12,marginTop:12}}>
                    <span style={badge("paid")}>{s.paidCount} төлсөн</span>
                    <span style={badge("partial")}>{s.partialCount} хэсэгчлэн</span>
                    <span style={badge("pending")}>{s.pendingCount} хүлээгдэж буй</span>
                  </div>
                </div>
              )}
            </div>

            {/* Invoice list */}
            {invs.length === 0 && (
              <div style={{textAlign:"center",padding:60,color:C.light}}>
                <div style={{fontSize:48,marginBottom:12}}>📄</div>
                <div style={{fontSize:14}}>Нэхэмжлэл бүртгэгдээгүй</div>
                <button onClick={()=>{setEditingInvoice(null);setInvClient("");setInvPhone("");setInvInfant(false);setInvType("package");setInvNotes("");const tm=new Date();tm.setDate(tm.getDate()+1);setInvDueDate(tm.toISOString().split("T")[0]);setInvInstall(false);setInvItems([{id:1,description:`${destInfo.name} аялал`,qty:1,rate:0}]);setPage("new-invoice")}} style={{...btnP,marginTop:16}}>+ Нэхэмжлэл нэмэх</button>
              </div>
            )}

            {/* Invoice search + table */}
            {invs.length > 0 && (
              <div style={{marginBottom:12}}>
                <input value={invSearchQ} onChange={e=>setInvSearchQ(e.target.value)} placeholder="🔍 Нэр, утас, код хайх..." style={{width:"100%",padding:"10px 16px",border:`1px solid ${C.border}`,borderRadius:10,fontSize:13,fontFamily:"'Outfit'",outline:"none",boxSizing:"border-box",background:"#fff"}}/>
              </div>
            )}
            {invs.length > 0 && (() => {
              const q = invSearchQ.toLowerCase().trim();
              const filtered = q ? invs.filter(inv =>
                (inv.clientName||"").toLowerCase().includes(q) ||
                (inv.clientPhone||"").includes(q) ||
                (inv.refCode||inv.txnValue||"").toLowerCase().includes(q) ||
                (inv.createdByLabel||inv.createdBy||"").toLowerCase().includes(q)
              ) : invs;
              return (
                <div style={{background:"#fff",borderRadius:14,border:`1px solid ${C.border}`,overflow:"hidden"}}>
                  {/* Table header */}
                  <div style={{display:"grid",gridTemplateColumns:"32px 1fr 80px 100px 100px 90px 90px 70px 70px",padding:"10px 16px",background:C.winePale,fontSize:8.5,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,borderBottom:`1px solid ${C.border}`}}>
                    <div>#</div>
                    <div>Зорчигч</div>
                    <div>Бүртгэсэн</div>
                    <div>Код</div>
                    <div style={{textAlign:"right"}}>Дүн</div>
                    <div style={{textAlign:"right"}}>Төлсөн</div>
                    <div style={{textAlign:"right"}}>Үлдэгдэл</div>
                    <div style={{textAlign:"center"}}>Төлөв</div>
                    <div style={{textAlign:"center"}}>Үйлдэл</div>
                  </div>
                  {filtered.length === 0 && <div style={{padding:30,textAlign:"center",color:C.light,fontSize:12}}>Олдсонгүй</div>}
                  {filtered.map((inv, i) => {
                    const paidAmt = inv.payments?.length ? inv.payments.filter(p=>!p.reversed).reduce((ss,p)=>ss+p.amount,0) : (inv.installEnabled && inv.installments?.length ? inv.installments.filter(x=>x.paid).reduce((ss,x)=>ss+x.amount,0) : (inv.paymentStatus==="paid"?inv.total:0));
                    const hasInfant = inv.isInfant || inv.items?.some(x=>x.type==="infant"||x.isInfant);
                    const mainType = inv.items?.[0]?.type || inv.invType || "package";
                    const typeInfo = {flight:{l:"🛫",c:C.blue},ground:{l:"🏨",c:C.orange},package:{l:"📦",c:C.wine},infant:{l:"👶",c:"#D97706"}};
                    const ti = typeInfo[mainType] || typeInfo.package;
                    const isExpanded = expandedInv === inv.id;
                    return (
                      <div key={inv.id}>
                        <div onClick={()=>setExpandedInv(isExpanded?null:inv.id)} style={{display:"grid",gridTemplateColumns:"32px 1fr 80px 100px 100px 90px 90px 70px 70px",padding:"10px 16px",alignItems:"center",borderBottom:`1px solid ${C.border}22`,background:inv.pendingEdit?"#FEF3C766":i%2===0?"#fff":"#FAFAFA",cursor:"pointer",transition:"background .15s"}}
                          onMouseEnter={e=>e.currentTarget.style.background=C.winePale}
                          onMouseLeave={e=>e.currentTarget.style.background=inv.pendingEdit?"#FEF3C766":i%2===0?"#fff":"#FAFAFA"}>
                          <div style={{fontSize:11,color:C.light,fontWeight:600}}>{String(i+1).padStart(2,"0")}</div>
                          <div style={{display:"flex",alignItems:"center",gap:6,overflow:"hidden"}}>
                            <span style={{fontSize:11}}>{ti.l}</span>
                            <span style={{fontWeight:600,fontSize:13,color:C.dark,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{inv.clientName}</span>
                            {hasInfant && <span style={{fontSize:7,padding:"1px 4px",borderRadius:6,background:"#FEF3C7",color:"#D97706",fontWeight:700}}>👶</span>}
                            {inv.pendingEdit && <span style={{fontSize:7,padding:"1px 4px",borderRadius:6,background:"#FEF3C7",color:"#D97706",fontWeight:700}}>⏳</span>}
                            <span style={{fontSize:10,color:C.muted}}>{inv.clientPhone}</span>
                          </div>
                          <div style={{fontSize:10,color:C.muted,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{inv.createdByLabel||inv.createdBy||"—"}</div>
                          <div style={{fontFamily:"monospace",fontSize:10,color:C.gold,fontWeight:600}}>{inv.refCode||"—"}</div>
                          <div style={{textAlign:"right",fontWeight:700,fontSize:13,color:C.dark}}>{fmt(inv.total)}</div>
                          <div style={{textAlign:"right",fontWeight:700,fontSize:12,color:paidAmt>0?"#059669":C.muted}}>{paidAmt>0?fmt(paidAmt):"—"}</div>
                          <div style={{textAlign:"right",fontWeight:700,fontSize:12,color:inv.total-paidAmt>0?C.red:"#059669"}}>{inv.total-paidAmt>0?fmt(inv.total-paidAmt):"✅"}</div>
                          <div style={{textAlign:"center"}}><span style={{...badge(inv.paymentStatus),fontSize:9,padding:"2px 8px"}}>{statusInfo[inv.paymentStatus]?.icon} {inv.paymentStatus==="partial"?Math.round(paidAmt/inv.total*100)+"%":statusInfo[inv.paymentStatus]?.label}</span></div>
                          <div style={{display:"flex",gap:4,justifyContent:"center"}}>
                            {!inv.pendingEdit && <button onClick={(e)=>{e.stopPropagation();startEditInvoice(inv)}} title="Засах" style={{width:26,height:26,background:C.blue,color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:11,display:"flex",alignItems:"center",justifyContent:"center"}}>✏️</button>}
                            <button onClick={(e)=>{e.stopPropagation();setSelectedInvoice(inv);setPage("pdf-preview")}} title="PDF" style={{width:26,height:26,background:C.wine,color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:11,display:"flex",alignItems:"center",justifyContent:"center"}}>📄</button>
                            {isManager && inv.paymentStatus==="pending" && <button onClick={(e)=>{e.stopPropagation();deleteInvoice(inv)}} title="Устгах" style={{width:26,height:26,background:C.red,color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontSize:11,display:"flex",alignItems:"center",justifyContent:"center"}}>🗑</button>}
                          </div>
                        </div>
                        {/* Expanded detail */}
                        {isExpanded && (
                          <div style={{padding:"12px 16px 12px 48px",background:"#FAFAFA",borderBottom:`1px solid ${C.border}44`,fontSize:11}}>
                            <div style={{display:"flex",gap:24,marginBottom:8,flexWrap:"wrap"}}>
                              <div><span style={{color:C.light,fontWeight:600}}>Огноо:</span> {inv.invDate}</div>
                              <div><span style={{color:C.light,fontWeight:600}}>Хугацаа:</span> {inv.dueDate||"—"}</div>
                              <div><span style={{color:C.light,fontWeight:600}}>Бүртгэсэн:</span> <span style={{color:C.wine,fontWeight:600}}>{inv.createdByLabel||inv.createdBy||"—"}</span></div>
                              {paidAmt > 0 && inv.paymentStatus!=="paid" && <div><span style={{color:C.light,fontWeight:600}}>Төлсөн:</span> <span style={{color:C.green,fontWeight:700}}>{fmt(paidAmt)}</span></div>}
                              {inv.paymentStatus!=="paid" && <div><span style={{color:C.light,fontWeight:600}}>Үлдэгдэл:</span> <span style={{color:C.red,fontWeight:700}}>{fmt(inv.total-paidAmt)}</span></div>}
                            </div>
                            {inv.items?.map((it,j)=>{
                              const tIcons = {flight:"🛫",ground:"🏨",package:"📦",infant:"👶"};
                              return <div key={j} style={{color:C.muted,marginBottom:2}}>{tIcons[it.type]||tIcons[inv.invType]||"📦"} {it.description} ({it.qty} хүн × {fmt(it.rate)})</div>;
                            })}
                            {/* Payment section - installments */}
                            {inv.installEnabled && inv.installments?.length > 0 && (
                              <div style={{marginTop:8,padding:"8px 10px",background:C.winePale,borderRadius:8}}>
                                <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,marginBottom:6}}>ТӨЛБӨРИЙН ХУВААРЬ</div>
                                {inv.installments.map((inst,idx)=>{
                                  const ds = !inst.paid ? getDueStatus(inst.date) : null;
                                  return (
                                    <div key={idx} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0",fontSize:10,borderBottom:idx<inv.installments.length-1?`1px solid ${C.border}33`:"none"}}>
                                      <div style={{display:"flex",gap:6,alignItems:"center"}}>
                                        <span style={{width:14,height:14,borderRadius:4,border:`2px solid ${inst.paid?C.green:C.border}`,background:inst.paid?C.green:"#fff",display:"inline-flex",alignItems:"center",justifyContent:"center",color:"#fff",fontSize:8,fontWeight:700}}>{inst.paid?"✓":""}</span>
                                        <span style={{color:inst.paid?C.green:C.text,fontWeight:600,textDecoration:inst.paid?"line-through":"none"}}>{inst.label}</span>
                                        <span style={{color:C.muted}}>{inst.date||"—"}</span>
                                        {ds && <span style={{fontSize:8,fontWeight:700,padding:"0 4px",borderRadius:8,background:ds.bg,color:ds.color}}>{ds.type==="overdue"?"🔴":"🟡"}</span>}
                                      </div>
                                      <span style={{fontWeight:600,color:inst.paid?C.green:C.dark}}>{fmt(inst.amount)}</span>
                                    </div>
                                  );
                                })}
                              </div>
                            )}
                            {/* Payment summary + history (read-only) */}
                            {(() => {
                              const pmts = inv.payments || [];
                              const paidTotal = pmts.filter(p=>!p.reversed).reduce((s,p) => s + p.amount, 0);
                              const ost = inv.total - paidTotal;
                              if (paidTotal === 0 && !inv.installEnabled && pmts.length === 0) return null;
                              return (
                                <div style={{marginTop:8,padding:"8px 10px",background:paidTotal >= inv.total ? "#ECFDF5" : "#FFF7ED",borderRadius:8,border:`1px solid ${paidTotal >= inv.total ? "#A7F3D0" : "#FED7AA"}`}}>
                                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:pmts.length > 0 ? 6 : 0}}>
                                    <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light}}>💰 ТӨЛБӨРИЙН МЭДЭЭЛЭЛ</div>
                                    <div style={{fontSize:11,fontWeight:700}}>
                                      <span style={{color:"#059669"}}>{fmt(paidTotal)}</span>
                                      <span style={{color:C.muted,fontWeight:400}}> / {fmt(inv.total)}</span>
                                      {ost > 0 && <span style={{color:C.red,marginLeft:8}}>Үлдэгдэл: {fmt(ost)}</span>}
                                      {paidTotal >= inv.total && <span style={{color:"#059669",marginLeft:8}}>✅ Бүрэн</span>}
                                    </div>
                                  </div>
                                  {/* Progress bar */}
                                  {paidTotal > 0 && paidTotal < inv.total && (
                                    <div style={{width:"100%",height:4,background:C.border,borderRadius:2,overflow:"hidden",marginBottom:6}}>
                                      <div style={{width:`${Math.round(paidTotal/inv.total*100)}%`,height:"100%",background:"linear-gradient(90deg,#059669,#10B981)",borderRadius:2}}/>
                                    </div>
                                  )}
                                  {pmts.length > 0 && pmts.map((p,idx) => (
                                    <div key={idx} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"3px 0",fontSize:10,borderTop:idx===0?`1px solid ${C.border}33`:"none",opacity:p.reversed?0.5:1}}>
                                      <div style={{color:C.muted}}>
                                        {new Date(p.date).toLocaleDateString("mn")} <span style={{color:p.reversed?C.red:"#059669",fontWeight:600}}>{p.byLabel||p.by}</span>
                                        {p.note && <span style={{marginLeft:4,opacity:.7}}>({p.note})</span>}
                                        {p.reversed && <span style={{marginLeft:4,fontSize:8,padding:"1px 4px",borderRadius:4,background:"#FEE2E2",color:C.red,fontWeight:700}}>БУЦААСАН</span>}
                                      </div>
                                      <span style={{fontWeight:700,color:p.reversed?C.red:"#059669",textDecoration:p.reversed?"line-through":"none"}}>{p.reversed?"-":"+"}{fmt(p.amount)}</span>
                                    </div>
                                  ))}
                                </div>
                              );
                            })()}
                            {inv.pendingEdit && isManager && (
                              <div style={{marginTop:8,padding:"8px 12px",background:"#FEF3C7",borderRadius:8,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                                <div style={{fontSize:10,color:"#92400E"}}><b>⏳ {inv.pendingEdit.by}:</b> {inv.pendingEdit.changes?.join(", ")}</div>
                                <div style={{display:"flex",gap:6}}>
                                  <button onClick={()=>approvePendingEdit(inv)} style={{padding:"4px 12px",background:C.green,color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontWeight:700,fontSize:10}}>✓ Батлах</button>
                                  <button onClick={()=>rejectPendingEdit(inv)} style={{padding:"4px 12px",background:C.red,color:"#fff",border:"none",borderRadius:6,cursor:"pointer",fontWeight:700,fontSize:10}}>✕ Татгалзах</button>
                                </div>
                              </div>
                            )}
                            {inv.editHistory?.length > 0 && (
                              <div style={{marginTop:6,paddingTop:6,borderTop:`1px dashed ${C.border}44`}}>
                                <div style={{fontSize:8,fontWeight:700,color:C.light,marginBottom:2}}>ЗАСВАРЫН ТҮҮХ</div>
                                {inv.editHistory.slice(-3).map((eh,idx) => (
                                  <div key={idx} style={{fontSize:9,color:C.muted}}>{new Date(eh.date).toLocaleDateString("mn")} <span style={{color:C.wine,fontWeight:600}}>{eh.byLabel||eh.by||""}</span> — {eh.changes.join(", ")}</div>
                                ))}
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              );
            })()}
          </div>
          {/* Cancel modal */}
          {showCancelModal && (
            <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",backdropFilter:"blur(4px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200}} onClick={()=>setShowCancelModal(false)}>
              <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:20,padding:"32px 36px",maxWidth:480,width:"100%",boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}}>
                <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:20}}>
                  <span style={{fontSize:24}}>⚠️</span>
                  <h2 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:C.dark}}>Аялал цуцлах</h2>
                </div>
                <div style={{background:C.redBg,border:`1px solid ${C.redBd}`,borderRadius:10,padding:"12px 16px",fontSize:12,color:C.red,lineHeight:1.7,marginBottom:16}}>
                  <b>Анхааруулга:</b> Энэ аялалтай холбоотой бүх хүлээгдэж буй нэхэмжлэл мөн цуцлагдана. Төлсөн нэхэмжлэлтэй аялал цуцлах боломжгүй.
                </div>
                <div style={{marginBottom:16}}>
                  <div style={{fontSize:12,color:C.muted,marginBottom:6}}>
                    <b>{trip.code}</b> · {destInfo.name} · {trip.date} · {invs.length} зорчигч · {fmt(s.total)}
                  </div>
                </div>
                <div style={{marginBottom:20}}>
                  <label style={{display:"block",fontSize:9,fontWeight:700,letterSpacing:".14em",textTransform:"uppercase",color:C.red,marginBottom:6,fontFamily:"'Outfit'"}}>Цуцлах шалтгаан *</label>
                  <textarea value={cancelReason} onChange={e=>setCancelReason(e.target.value)} rows={3} placeholder="Шалтгаанаа бичнэ үү... (жишээ: Аялал цуцлагдсан, Буруу бүртгэгдсэн)" style={{width:"100%",padding:"10px 14px",border:`1px solid ${C.redBd}`,borderRadius:10,fontSize:13,fontFamily:"'Outfit',sans-serif",outline:"none",boxSizing:"border-box",resize:"vertical"}}/>
                </div>
                <div style={{display:"flex",justifyContent:"flex-end",gap:10}}>
                  <button onClick={()=>{setShowCancelModal(false);setCancelReason("")}} style={btnS}>Болих</button>
                  <button onClick={()=>cancelTrip(trip,cancelReason)} style={{...btnP,background:C.red}}>🚫 Цуцлах</button>
                </div>
              </div>
            </div>
          )}
          {saveMsg && <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"12px 28px",background:saveMsg.includes("✓")?C.green:C.red,color:"#fff",borderRadius:50,fontFamily:"'Outfit'",fontWeight:600,fontSize:13,boxShadow:"0 4px 24px rgba(0,0,0,.2)",zIndex:100}}>{saveMsg}</div>}
        </div>
      </>
    );
  }


  /* ═══════════════════════════════════════════
     NEW INVOICE (within a trip)
     ═══════════════════════════════════════════ */
  if (page === "new-invoice" && selectedTrip) {
    const trip = selectedTrip;
    const destInfo = DEST_CODES[trip.dest] || { color: C.wine, bg: C.winePale, name: trip.destName || trip.dest };
    const bankInfo = ALL_BANKS[trip.bank] || Object.values(ALL_BANKS)[0];
    const invTotal = invItems.reduce((s, i) => s + i.qty * i.rate, 0);
    return (
      <>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap');
          *{box-sizing:border-box;margin:0;padding:0}
          input:focus,select:focus,textarea:focus{border-color:${C.wine}!important;box-shadow:0 0 0 3px ${C.wine}18!important}
          @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
          .fu{animation:fadeUp .35s ease both}
          .dashed:hover{background:${C.winePale}!important;border-color:${C.border}!important;color:${C.wine}!important}
          @media(max-width:680px){.rg{grid-template-columns:1fr!important}}
        `}</style>
        <div style={{minHeight:"100vh",background:`linear-gradient(170deg, ${C.wineBg} 0%, #F5F0EE 40%, ${C.wineBg} 100%)`,fontFamily:"'Outfit',sans-serif"}}>
          <div style={{background:C.winePale,borderBottom:`2px solid ${C.border}`,padding:"0 28px",height:54,display:"flex",justifyContent:"space-between",alignItems:"center",position:"sticky",top:0,zIndex:50}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <button onClick={()=>setPage("trip-detail")} style={{background:"none",border:"none",fontSize:14,color:C.muted,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:500}}>← {trip.code}</button>
              <span style={{color:C.wine,fontWeight:600,fontSize:13,opacity:.3}}>|</span>
              <span style={{color:C.text,fontWeight:600,fontSize:13}}>{editingInvoice ? "Нэхэмжлэл засах" : "Шинэ нэхэмжлэл"}</span>
            </div>
            <button onClick={editingInvoice ? saveEditInvoice : submitInvoice} style={btnP}>{editingInvoice ? "💾 Засвар хадгалах" : "💾 Хадгалах"}</button>
          </div>

          <div style={{maxWidth:880,margin:"0 auto",padding:"24px 20px 80px"}}>
            {/* Trip badge */}
            <div className="fu" style={{background:destInfo.bg,borderRadius:12,padding:"14px 20px",border:`1px solid ${destInfo.color}22`,marginBottom:20,display:"flex",alignItems:"center",gap:14}}>
              <span style={{fontFamily:"monospace",fontWeight:800,fontSize:16,color:destInfo.color}}>{trip.code}</span>
              <span style={{color:destInfo.color,fontSize:12}}>{destInfo.name} · {trip.date}</span>
              <span style={{marginLeft:"auto",fontSize:12,color:C.muted}}>Банк: {bankInfo.bank}</span>
            </div>

            {/* Client */}
            <div className="fu" style={{...cardS,animationDelay:".04s"}}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:16}}>
                <div style={{width:3,height:18,background:C.wine,borderRadius:2}}/>
                <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark}}>Зорчигчийн мэдээлэл</h3>
              </div>
              <div className="rg" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                <div><label style={lbl}>Нэр *</label><input value={invClient} onChange={e=>setInvClient(e.target.value)} placeholder="Зорчигчийн нэр" style={{...inp,borderColor:!invClient.trim()&&invPhone?"#FECACA":undefined}}/></div>
                <div><label style={lbl}>Утас *</label><input value={invPhone} onChange={e=>setInvPhone(e.target.value)} placeholder="+976 ..." style={{...inp,borderColor:invClient.trim()&&!invPhone.trim()?"#FECACA":undefined}}/></div>
              </div>
            </div>

            {/* Bank info (read-only) */}
            <div className="fu" style={{...cardS,background:`linear-gradient(135deg, ${C.winePale}, ${C.goldLight})`,animationDelay:".07s"}}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:14}}>
                <div style={{width:3,height:18,background:C.gold,borderRadius:2}}/>
                <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark}}>Банкны мэдээлэл</h3>
              </div>
              <div className="rg" style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12}}>
                <div><label style={lbl}>Банк</label><div style={{...inp,background:"#fff",border:`1px solid ${C.border}`,fontWeight:600,cursor:"default"}}>{bankInfo.bank}</div></div>
                <div><label style={lbl}>IBAN</label><div style={{...inp,background:"#fff",border:`1px solid ${C.border}`,fontWeight:600,cursor:"default",fontFamily:"monospace",letterSpacing:".04em"}}>{bankInfo.iban}</div></div>
                <div><label style={lbl}>Хүлээн авагч</label><div style={{...inp,background:"#fff",border:`1px solid ${C.border}`,fontWeight:600,cursor:"default"}}>{COMPANY}</div></div>
              </div>
              <div style={{marginTop:10,padding:"10px 14px",background:C.goldLight,borderRadius:8}}>
                <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:4}}>
                  <span style={{fontSize:9,fontWeight:700,letterSpacing:".12em",textTransform:"uppercase",color:C.gold}}>Гүйлгээний утга</span>
                </div>
                <span style={{fontFamily:"monospace",fontWeight:700,color:C.dark,fontSize:13}}>{[editingInvoice?.refCode || (() => { const bc=selectedTrip.code.replace(/-/g,"").toLowerCase(); const ec=invoices.filter(i=>i.tripCode===selectedTrip.code).length; return `${bc}-${String(ec+1).padStart(2,"0")}`; })(), invClient, invPhone].filter(Boolean).join(" / ")}</span>
              </div>
            </div>

            {/* Line items */}
            <div className="fu" style={{...cardS,animationDelay:".1s"}}>
              <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:16}}>
                <div style={{width:3,height:18,background:C.wine,borderRadius:2}}/>
                <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark}}>Үйлчилгээ</h3>
              </div>
              {/* Column headers */}
              <div style={{display:"grid",gridTemplateColumns:"110px 1fr 60px 110px 110px 28px",gap:8,marginBottom:6}}>
                <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light}}>Төрөл</div>
                <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light}}>Үйлчилгээ *</div>
                <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,textAlign:"center"}}>Хүн *</div>
                <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,textAlign:"right"}}>Үнэ *</div>
                <div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,textAlign:"right"}}>Дүн</div>
                <div/>
              </div>
              {invItems.map((it,idx)=>(
                <div key={it.id} style={{display:"grid",gridTemplateColumns:"110px 1fr 60px 110px 110px 28px",gap:8,marginBottom:8,alignItems:"center"}}>
                  <select value={it.type||"package"} onChange={e=>{const n=[...invItems];n[idx]={...n[idx],type:e.target.value};setInvItems(n)}} style={{...inp,fontSize:11,padding:"8px 6px",background:"#fff",cursor:"pointer"}}>
                    <option value="package">📦 Багц</option>
                    <option value="flight">🛫 Нислэг</option>
                    <option value="ground">🏨 Газар</option>
                    <option value="infant">👶 Нялх</option>
                  </select>
                  <input value={it.description} onChange={e=>{const n=[...invItems];n[idx]={...n[idx],description:e.target.value};setInvItems(n)}} placeholder={`${destInfo.name} аялал`} style={inp}/>
                  <input type="number" min={1} value={it.qty} onChange={e=>{const n=[...invItems];n[idx]={...n[idx],qty:Math.max(1,+e.target.value)};setInvItems(n)}} style={{...inp,textAlign:"center"}}/>
                  <input type="number" min={0} step={1000} value={it.rate} onChange={e=>{const n=[...invItems];n[idx]={...n[idx],rate:Math.max(0,+e.target.value)};setInvItems(n)}} style={{...inp,textAlign:"right"}}/>
                  <div style={{...inp,background:C.winePale,border:`1px solid ${C.border}`,fontWeight:600,textAlign:"right",cursor:"default"}}>{fmt(it.qty*it.rate)}</div>
                  {invItems.length>1&&<button onClick={()=>setInvItems(p=>p.filter((_,i)=>i!==idx))} style={{background:"none",border:"none",fontSize:16,color:C.light,cursor:"pointer"}}>×</button>}
                </div>
              ))}
              <button className="dashed" onClick={()=>setInvItems(p=>[...p,{id:Date.now(),description:"",qty:1,rate:0,type:"package"}])} style={{marginTop:6,padding:"8px 0",background:"#fff",border:`1.5px dashed ${C.border}`,borderRadius:8,cursor:"pointer",fontSize:12,fontWeight:600,color:C.light,width:"100%",fontFamily:"'Outfit'"}}>+ Нэмэх</button>
              <div style={{marginTop:14,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                <div><label style={lbl}>Төлбөрийн хугацаа</label><input type="date" value={invDueDate} onChange={e=>setInvDueDate(e.target.value)} style={{...inp,width:180}}/></div>
                <div style={{background:C.dark,color:"#fff",borderRadius:10,padding:"12px 24px",display:"flex",alignItems:"baseline",gap:12,border:`2px solid ${C.wine}`}}>
                  <span style={{fontSize:9,fontWeight:600,letterSpacing:".12em",textTransform:"uppercase",opacity:.6}}>Нийт</span>
                  <span style={{fontFamily:"'Cormorant Garamond',serif",fontSize:24,fontWeight:700,color:C.gold}}>{fmt(invTotal)}</span>
                </div>
              </div>
            </div>

            {/* Installments */}
            <div className="fu" style={{...cardS,animationDelay:".14s"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:invInstall?16:0}}>
                <div style={{display:"flex",alignItems:"center",gap:8}}>
                  <div style={{width:3,height:18,background:C.wine,borderRadius:2}}/>
                  <h3 style={{fontFamily:"'Cormorant Garamond',serif",fontSize:20,fontWeight:700,color:C.dark}}>Хуваарьт төлбөр</h3>
                </div>
                <button onClick={()=>setInvInstall(!invInstall)} style={{padding:"5px 14px",background:invInstall?C.wine:"#fff",color:invInstall?"#fff":C.muted,border:`1px solid ${invInstall?C.wine:C.border}`,borderRadius:20,cursor:"pointer",fontFamily:"'Outfit'",fontWeight:600,fontSize:11}}>{invInstall?"✓ Идэвхтэй":"Идэвхжүүлэх"}</button>
              </div>
              {invInstall && (
                <div>
                  <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:14}}>
                    <label style={{...lbl,marginBottom:0}}>Хуваах тоо</label>
                    {[2,3,4,5,6].map(n=><button key={n} onClick={()=>{setInvInstallCount(n);const eqPct=Math.round(100/n);setInvInstallments(Array.from({length:n},(_,i)=>({pct:i===n-1?100-eqPct*(n-1):eqPct,date:invInstallments[i]?.date||""})))}} style={{width:34,height:34,borderRadius:8,border:`1px solid ${invInstallCount===n?C.wine:C.border}`,background:invInstallCount===n?C.winePale:"#fff",color:invInstallCount===n?C.wine:C.muted,fontWeight:700,fontSize:14,cursor:"pointer",fontFamily:"'Outfit'"}}>{n}</button>)}
                  </div>
                  {/* Column headers */}
                  <div style={{display:"grid",gridTemplateColumns:"36px 80px 1fr 1fr",gap:10,marginBottom:4}}>
                    <div/><div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,textAlign:"center"}}>Хувь %</div><div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light,textAlign:"right"}}>Дүн</div><div style={{fontSize:8,fontWeight:700,letterSpacing:".1em",textTransform:"uppercase",color:C.light}}>Огноо</div>
                  </div>
                  {Array.from({length:invInstallCount}).map((_,idx)=>{
                    const pctVal = invInstallments[idx]?.pct ?? Math.round(100/invInstallCount);
                    const amt = Math.round(invTotal * pctVal / 100);
                    const totalPct = invInstallments.reduce((s,x,i)=> i < invInstallCount ? s + (x?.pct ?? Math.round(100/invInstallCount)) : s, 0);
                    return (
                      <div key={idx} style={{display:"grid",gridTemplateColumns:"36px 80px 1fr 1fr",gap:10,marginBottom:6,alignItems:"center"}}>
                        <div style={{textAlign:"center",fontSize:12,fontWeight:700,color:C.light}}>{idx+1}</div>
                        <div style={{position:"relative"}}>
                          <input type="number" min={1} max={100} value={pctVal} onChange={e=>{const n=[...invInstallments];while(n.length<=idx)n.push({pct:0,date:""});n[idx]={...n[idx],pct:Math.max(0,Math.min(100,+e.target.value||0))};setInvInstallments(n)}} style={{...inp,textAlign:"center",fontWeight:700,fontSize:15,color:C.wine,paddingRight:24}}/>
                          <span style={{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",fontWeight:700,color:C.light,fontSize:13}}>%</span>
                        </div>
                        <div style={{...inp,background:C.winePale,border:`1px solid ${C.border}`,fontWeight:600,textAlign:"right",cursor:"default"}}>{fmt(amt)}</div>
                        <input type="date" value={invInstallments[idx]?.date||""} onChange={e=>{const n=[...invInstallments];while(n.length<=idx)n.push({pct:pctVal,date:""});n[idx]={...n[idx],date:e.target.value};setInvInstallments(n)}} style={inp}/>
                      </div>
                    );
                  })}
                  {/* Total percentage indicator */}
                  {(()=>{const tp=invInstallments.slice(0,invInstallCount).reduce((s,x)=>s+(x?.pct??0),0);return(
                    <div style={{display:"flex",justifyContent:"flex-end",marginTop:6,gap:12,alignItems:"center"}}>
                      <span style={{fontSize:11,color:tp===100?C.green:C.red,fontWeight:700}}>Нийт: {tp}%</span>
                      {tp!==100&&<span style={{fontSize:10,color:C.red}}>⚠ 100% байх ёстой</span>}
                      {tp===100&&<span style={{fontSize:10,color:C.green}}>✓</span>}
                    </div>
                  );})()}
                </div>
              )}
            </div>

            {/* Notes */}
            <div className="fu" style={{...cardS,animationDelay:".17s"}}>
              <label style={lbl}>Тэмдэглэл</label>
              <textarea value={invNotes} onChange={e=>setInvNotes(e.target.value)} rows={2} placeholder="Нэмэлт тэмдэглэл..." style={{...inp,resize:"vertical"}}/>
            </div>

            {/* Warning */}
            <div className="fu" style={{background:"#FFF8F0",border:"1px solid #F5D5B8",borderRadius:10,padding:"14px 20px",fontSize:11.5,color:"#8B4513",lineHeight:1.8,animationDelay:".2s"}}>
              <b>⚠ </b><b>АЯЛЛЫН ДУГААР</b>, <b>АЯЛАГЧЫН НЭР</b>, <b>УТАСНЫ ДУГААР</b>-аа гүйлгээний утга дээр заавал бичээрэй!
            </div>
          </div>
          {saveMsg && <div style={{position:"fixed",bottom:24,left:"50%",transform:"translateX(-50%)",padding:"12px 28px",background:saveMsg.includes("✓")?C.green:C.red,color:"#fff",borderRadius:50,fontFamily:"'Outfit'",fontWeight:600,fontSize:13,boxShadow:"0 4px 24px rgba(0,0,0,.2)",zIndex:100}}>{saveMsg}</div>}
        </div>
      </>
    );
  }

  return null;
}
